{% extends layout_path %}
{% load static %}

{% block title %}Contact Messages{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{% url 'dashboards:overview' %}">Home</a>
</li>
<li class="breadcrumb-item active">Contact Messages</li>
{% endblock breadcrumb %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="py-3 mb-4">
    <span class="text-muted fw-light">Management /</span> Contact Messages
  </h4>

  <!-- Contact Messages List Card -->
  <div class="card">
    <div class="card-header border-bottom">
      <h5 class="card-title mb-3">Contact Messages</h5>
      <div class="d-flex justify-content-between align-items-center row pb-2 gap-3 gap-md-0">
        <div class="col-md-4 status_filter">
          <select id="StatusFilter" class="form-select text-capitalize">
            <option value="">All Status</option>
            <option value="new" {% if request.GET.status == 'new' %}selected{% endif %}>New</option>
            <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
          </select>
        </div>
        <div class="col-md-4 message_search">
          <div class="input-group input-group-merge">
            <span class="input-group-text" id="basic-addon-search31"><i class="ti ti-search"></i></span>
            <input type="text" class="form-control" placeholder="Search..." aria-label="Search..." aria-describedby="basic-addon-search31" value="{{ search_query }}">
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive text-nowrap">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          {% for message in messages %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ message.name }}</td>
            <td>{{ message.email }}</td>
            <td>{{ message.subject|truncatechars:30 }}</td>
            <td>
              <span class="badge bg-label-{% if message.status == 'new' %}primary{% elif message.status == 'in_progress' %}warning{% else %}success{% endif %} me-1">
                {{ message.get_status_display }}
              </span>
            </td>
            <td>{{ message.created_at|date:"d M Y" }}</td>
            <td>
              <div class="dropdown">
                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                  <i class="ti ti-dots-vertical"></i>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#viewMessageModal{{ message.id }}">
                    <i class="ti ti-eye me-1"></i> View
                  </a>
                  <a class="dropdown-item" href="mailto:{{ message.email }}">
                    <i class="ti ti-mail me-1"></i> Reply
                  </a>
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changeStatusModal{{ message.id }}">
                    <i class="ti ti-edit me-1"></i> Change Status
                  </a>
                </div>
              </div>
              
              <!-- View Message Modal -->
              <div class="modal fade" id="viewMessageModal{{ message.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Message Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row mb-3">
                        <div class="col-sm-3">
                          <h6 class="mb-0">From:</h6>
                        </div>
                        <div class="col-sm-9">
                          <p class="text-muted mb-0">{{ message.name }} ({{ message.email }})</p>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-sm-3">
                          <h6 class="mb-0">Subject:</h6>
                        </div>
                        <div class="col-sm-9">
                          <p class="text-muted mb-0">{{ message.subject }}</p>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-sm-3">
                          <h6 class="mb-0">Date:</h6>
                        </div>
                        <div class="col-sm-9">
                          <p class="text-muted mb-0">{{ message.created_at|date:"d M Y H:i" }}</p>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-sm-3">
                          <h6 class="mb-0">Status:</h6>
                        </div>
                        <div class="col-sm-9">
                          <span class="badge bg-label-{% if message.status == 'new' %}primary{% elif message.status == 'in_progress' %}warning{% else %}success{% endif %}">
                            {{ message.get_status_display }}
                          </span>
                        </div>
                      </div>
                      <hr>
                      <div class="row">
                        <div class="col-sm-3">
                          <h6 class="mb-0">Message:</h6>
                        </div>
                        <div class="col-sm-9">
                          <p class="text-muted mb-0" style="white-space: pre-line;">{{ message.message }}</p>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <a href="mailto:{{ message.email }}" class="btn btn-primary">
                        <i class="ti ti-mail me-1"></i> Reply via Email
                      </a>
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Change Status Modal -->
              <div class="modal fade" id="changeStatusModal{{ message.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Change Status</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="">
                      {% csrf_token %}
                      <input type="hidden" name="message_id" value="{{ message.id }}">
                      <div class="modal-body">
                        <div class="mb-3">
                          <label for="statusSelect{{ message.id }}" class="form-label">Select Status</label>
                          <select class="form-select" id="statusSelect{{ message.id }}" name="status">
                            <option value="new" {% if message.status == 'new' %}selected{% endif %}>New</option>
                            <option value="in_progress" {% if message.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if message.status == 'completed' %}selected{% endif %}>Completed</option>
                          </select>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-4">No messages found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="card-footer">
      <div class="d-flex justify-content-center">
        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item prev">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item prev disabled">
              <a class="page-link" href="javascript:void(0);">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% endif %}
            
            {% for num in paginator.page_range %}
              {% if num == page_obj.number %}
              <li class="page-item active">
                <a class="page-link" href="javascript:void(0);">{{ num }}</a>
              </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
              </li>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item next">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item next disabled">
              <a class="page-link" href="javascript:void(0);">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block page_js %}
<script>
  // Handle status filter
  document.getElementById('StatusFilter').addEventListener('change', function() {
    const selectedStatus = this.value;
    const currentUrl = new URL(window.location);
    
    if (selectedStatus) {
      currentUrl.searchParams.set('status', selectedStatus);
    } else {
      currentUrl.searchParams.delete('status');
    }
    
    // Reset to page 1 when filtering
    currentUrl.searchParams.set('page', '1');
    
    window.location.href = currentUrl.href;
  });
  
  // Handle search
  document.querySelector('.message_search input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const searchQuery = this.value;
      const currentUrl = new URL(window.location);
      
      if (searchQuery) {
        currentUrl.searchParams.set('search', searchQuery);
      } else {
        currentUrl.searchParams.delete('search');
      }
      
      // Preserve status filter if exists
      const selectedStatus = document.getElementById('StatusFilter').value;
      if (selectedStatus) {
        currentUrl.searchParams.set('status', selectedStatus);
      }
      
      // Reset to page 1 when searching
      currentUrl.searchParams.set('page', '1');
      
      window.location.href = currentUrl.href;
    }
  });
</script>
{% endblock page_js %}