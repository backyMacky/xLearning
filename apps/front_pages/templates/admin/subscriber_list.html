{% extends layout_path %}
{% load static %}

{% block title %}Newsletter Subscribers{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{% url 'dashboards:overview' %}">Home</a>
</li>
<li class="breadcrumb-item active">Newsletter Subscribers</li>
{% endblock breadcrumb %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="py-3 mb-4">
    <span class="text-muted fw-light">Management /</span> Newsletter Subscribers
  </h4>

  <!-- Subscribers List Card -->
  <div class="card">
    <div class="card-header border-bottom">
      <h5 class="card-title mb-3">Subscribers</h5>
      <div class="d-flex justify-content-between align-items-center row pb-2 gap-3 gap-md-0">
        <div class="col-md-4 status_filter">
          <select id="StatusFilter" class="form-select text-capitalize">
            <option value="">All Subscribers</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        <div class="col-md-4 subscriber_search">
          <div class="input-group input-group-merge">
            <span class="input-group-text" id="basic-addon-search31"><i class="ti ti-search"></i></span>
            <input type="text" class="form-control" placeholder="Search..." aria-label="Search..." aria-describedby="basic-addon-search31" value="{{ search_query }}">
          </div>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="ti ti-download me-1"></i> Export List
          </button>
        </div>
      </div>
    </div>
    <div class="table-responsive text-nowrap">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Email</th>
            <th>Subscription Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          {% for subscriber in subscribers %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ subscriber.email }}</td>
            <td>{{ subscriber.subscribed_at|date:"d M Y" }}</td>
            <td>
              <span class="badge bg-label-{% if subscriber.is_active %}success{% else %}danger{% endif %} me-1">
                {% if subscriber.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td>
              <div class="dropdown">
                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                  <i class="ti ti-dots-vertical"></i>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#toggleStatusModal{{ subscriber.id }}">
                    <i class="ti ti-toggle-right me-1"></i> Toggle Status
                  </a>
                  <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal{{ subscriber.id }}">
                    <i class="ti ti-trash me-1"></i> Delete
                  </a>
                </div>
              </div>
              
              <!-- Toggle Status Modal -->
              <div class="modal fade" id="toggleStatusModal{{ subscriber.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Change Subscription Status</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="">
                      {% csrf_token %}
                      <input type="hidden" name="subscriber_id" value="{{ subscriber.id }}">
                      <input type="hidden" name="action" value="toggle_status">
                      <div class="modal-body">
                        <p>Are you sure you want to {% if subscriber.is_active %}deactivate{% else %}activate{% endif %} this subscription?</p>
                        <p><strong>Email:</strong> {{ subscriber.email }}</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                          {% if subscriber.is_active %}Deactivate{% else %}Activate{% endif %}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
              <!-- Delete Modal -->
              <div class="modal fade" id="deleteModal{{ subscriber.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Delete Subscription</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="">
                      {% csrf_token %}
                      <input type="hidden" name="subscriber_id" value="{{ subscriber.id }}">
                      <input type="hidden" name="action" value="delete">
                      <div class="modal-body">
                        <div class="alert alert-warning" role="alert">
                          <h6 class="alert-heading mb-1">Warning</h6>
                          <p class="mb-0">This action cannot be undone. The subscriber will be permanently removed.</p>
                        </div>
                        <p>Are you sure you want to delete this subscription?</p>
                        <p><strong>Email:</strong> {{ subscriber.email }}</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center py-4">No subscribers found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="card-footer">
      <div class="d-flex justify-content-center">
        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item prev">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item prev disabled">
              <a class="page-link" href="javascript:void(0);">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% endif %}
            
            {% for num in paginator.page_range %}
              {% if num == page_obj.number %}
              <li class="page-item active">
                <a class="page-link" href="javascript:void(0);">{{ num }}</a>
              </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
              </li>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item next">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item next disabled">
              <a class="page-link" href="javascript:void(0);">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Subscribers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="">
          {% csrf_token %}
          <input type="hidden" name="action" value="export">
          <div class="modal-body">
            <div class="mb-3">
              <label for="exportFormat" class="form-label">Export Format</label>
              <select class="form-select" id="exportFormat" name="format">
                <option value="csv">CSV</option>
                <option value="excel">Excel</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="exportStatus" class="form-label">Subscriber Status</label>
              <select class="form-select" id="exportStatus" name="export_status">
                <option value="all">All Subscribers</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Export</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block page_js %}
<script>
  // Handle status filter
  document.getElementById('StatusFilter').addEventListener('change', function() {
    const selectedStatus = this.value;
    const currentUrl = new URL(window.location);
    
    if (selectedStatus) {
      currentUrl.searchParams.set('status', selectedStatus);
    } else {
      currentUrl.searchParams.delete('status');
    }
    
    // Reset to page 1 when filtering
    currentUrl.searchParams.set('page', '1');
    
    window.location.href = currentUrl.href;
  });
  
  // Handle search
  document.querySelector('.subscriber_search input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const searchQuery = this.value;
      const currentUrl = new URL(window.location);
      
      if (searchQuery) {
        currentUrl.searchParams.set('search', searchQuery);
      } else {
        currentUrl.searchParams.delete('search');
      }
      
      // Preserve status filter if exists
      const selectedStatus = document.getElementById('StatusFilter').value;
      if (selectedStatus) {
        currentUrl.searchParams.set('status', selectedStatus);
      }
      
      // Reset to page 1 when searching
      currentUrl.searchParams.set('page', '1');
      
      window.location.href = currentUrl.href;
    }
  });
</script>
{% endblock page_js %}