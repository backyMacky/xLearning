{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}My Sessions - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/fullcalendar/fullcalendar.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/fullcalendar/fullcalendar.js' %}"></script>
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <!-- Header Section -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div>
          <h4 class="mb-1">My Sessions</h4>
          <p class="mb-0">Manage all your upcoming and past sessions</p>
        </div>
        
        {% if is_student_view %}
        <div class="d-flex align-items-center gap-2">
          <div class="border rounded px-3 py-2 bg-light">
            <span class="d-block text-muted small">Credits</span>
            <span class="fw-semibold">{{ credit_balance|default:"0" }}</span>
          </div>
          <a href="{% url 'booking:purchase_credits' %}" class="btn btn-primary">
            <i class="ti ti-plus me-1"></i> Buy Credits
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Calendar View -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Upcoming Sessions Calendar</h5>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-primary active" id="calendarViewMonth">Month</button>
          <button type="button" class="btn btn-outline-primary" id="calendarViewWeek">Week</button>
          <button type="button" class="btn btn-outline-primary" id="calendarViewDay">Day</button>
        </div>
      </div>
      <div class="card-body">
        <div id="sessions-calendar" style="height: 500px;"></div>
      </div>
    </div>
  </div>
  
  <!-- Sessions View -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming-sessions" type="button" role="tab" aria-selected="true">
              Upcoming
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-sessions" type="button" role="tab" aria-selected="false">
              Past
            </button>
          </li>
        </ul>
      </div>
      
      <div class="tab-content">
        <!-- Upcoming Sessions Tab -->
        <div class="tab-pane fade show active" id="upcoming-sessions" role="tabpanel" aria-labelledby="upcoming-tab">
          <div class="card-body">
            <h6 class="mb-3">Private Sessions</h6>
            {% if upcoming_private_sessions %}
              <div class="table-responsive mb-4">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Instructor</th>
                      <th>Date & Time</th>
                      <th>Language</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in upcoming_private_sessions %}
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            {% if session.instructor.profile_image %}
                              <img src="{{ session.instructor.profile_image.url }}" alt="{{ session.instructor.user.username }}" class="rounded-circle me-2" width="32" height="32">
                            {% else %}
                              <div class="avatar me-2">
                                <div class="avatar-initial rounded-circle bg-label-primary">
                                  <i class="ti ti-user ti-xs"></i>
                                </div>
                              </div>
                            {% endif %}
                            <span>{{ session.instructor.user.username }}</span>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span>{{ session.start_time|date:"D, M d, Y" }}</span>
                            <small class="d-block text-muted">{{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-label-primary">{{ session.language.name }}</span>
                          <span class="badge bg-label-info">{{ session.level.name }}</span>
                        </td>
                        <td>
                          <span class="badge bg-label-success">Confirmed</span>
                        </td>
                        <td>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow" type="button" id="sessionMenu{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="ti ti-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sessionMenu{{ forloop.counter }}">
                              <li>
                                <a class="dropdown-item" href="#">
                                  <i class="ti ti-eye me-1"></i> View Details
                                </a>
                              </li>
                              {% if session.meeting_link %}
                                <li>
                                  <a class="dropdown-item" href="{{ session.meeting_link }}" target="_blank">
                                    <i class="ti ti-video me-1"></i> Join Meeting
                                  </a>
                                </li>
                              {% endif %}
                              {% if session.start_time|date:"U"|add:"0" > now|date:"U"|add:"3600" %}
                                <li>
                                  <a class="dropdown-item text-danger" href="{% url 'booking:cancel_private_session' slot_id=session.id %}">
                                    <i class="ti ti-calendar-off me-1"></i> Cancel
                                  </a>
                                </li>
                              {% endif %}
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <div class="d-flex">
                  <i class="ti ti-info-circle me-2"></i>
                  <div>You have no upcoming private sessions.</div>
                </div>
              </div>
            {% endif %}
            
            <h6 class="mb-3">Group Sessions</h6>
            {% if upcoming_group_sessions %}
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Session</th>
                      <th>Instructor</th>
                      <th>Date & Time</th>
                      <th>Participants</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in upcoming_group_sessions %}
                      <tr>
                        <td>
                          <div>
                            <span>{{ session.title }}</span>
                            <div>
                              <span class="badge bg-label-primary">{{ session.language.name }}</span>
                              <span class="badge bg-label-info">{{ session.level.name }}</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            {% if session.instructor.profile_image %}
                              <img src="{{ session.instructor.profile_image.url }}" alt="{{ session.instructor.user.username }}" class="rounded-circle me-2" width="32" height="32">
                            {% else %}
                              <div class="avatar me-2">
                                <div class="avatar-initial rounded-circle bg-label-primary">
                                  <i class="ti ti-user ti-xs"></i>
                                </div>
                              </div>
                            {% endif %}
                            <span>{{ session.instructor.user.username }}</span>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span>{{ session.start_time|date:"D, M d, Y" }}</span>
                            <small class="d-block text-muted">{{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}</small>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <span>{{ session.students.count }}/{{ session.max_students }}</span>
                            <div class="progress ms-2" style="width: 60px; height: 5px;">
                              <div class="progress-bar" style="width: {{ session.enrollment_percentage }}%"></div>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow" type="button" id="groupSessionMenu{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="ti ti-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="groupSessionMenu{{ forloop.counter }}">
                              <li>
                                <a class="dropdown-item" href="{% url 'content:group_session_detail' session_id=session.id %}">
                                  <i class="ti ti-eye me-1"></i> View Details
                                </a>
                              </li>
                              {% if session.meeting_link %}
                                <li>
                                  <a class="dropdown-item" href="{{ session.meeting_link }}" target="_blank">
                                    <i class="ti ti-video me-1"></i> Join Meeting
                                  </a>
                                </li>
                              {% endif %}
                              {% if session.start_time|date:"U"|add:"0" > now|date:"U"|add:"3600" %}
                                <li>
                                  <a class="dropdown-item text-danger" href="{% url 'booking:unenroll_group_session' session_id=session.id %}">
                                    <i class="ti ti-user-minus me-1"></i> Leave Session
                                  </a>
                                </li>
                              {% endif %}
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <div class="d-flex">
                  <i class="ti ti-info-circle me-2"></i>
                  <div>You have no upcoming group sessions.</div>
                </div>
              </div>
            {% endif %}
            
            {% if not upcoming_private_sessions and not upcoming_group_sessions %}
              <div class="text-center py-4">
                <div class="avatar avatar-md mx-auto mb-3">
                  <div class="avatar-initial rounded-circle bg-label-primary">
                    <i class="ti ti-calendar-off"></i>
                  </div>
                </div>
                <h6 class="mb-1">No upcoming sessions</h6>
                <p class="mb-3">You haven't booked any sessions yet</p>
                <a href="{% url 'booking:dashboard' %}" class="btn btn-primary">
                  <i class="ti ti-calendar-plus me-1"></i> Book a Session
                </a>
              </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Past Sessions Tab -->
        <div class="tab-pane fade" id="past-sessions" role="tabpanel" aria-labelledby="past-tab">
          <div class="card-body">
            <h6 class="mb-3">Private Sessions</h6>
            {% if past_private_sessions %}
              <div class="table-responsive mb-4">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Instructor</th>
                      <th>Date & Time</th>
                      <th>Language</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in past_private_sessions %}
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            {% if session.instructor.profile_image %}
                              <img src="{{ session.instructor.profile_image.url }}" alt="{{ session.instructor.user.username }}" class="rounded-circle me-2" width="32" height="32">
                            {% else %}
                              <div class="avatar me-2">
                                <div class="avatar-initial rounded-circle bg-label-primary">
                                  <i class="ti ti-user ti-xs"></i>
                                </div>
                              </div>
                            {% endif %}
                            <span>{{ session.instructor.user.username }}</span>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span>{{ session.start_time|date:"D, M d, Y" }}</span>
                            <small class="d-block text-muted">{{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-label-primary">{{ session.language.name }}</span>
                          <span class="badge bg-label-info">{{ session.level.name }}</span>
                        </td>
                        <td>
                          <span class="badge bg-label-{{ session.status|lower|slugify }}">
                            {{ session.status|title }}
                          </span>
                        </td>
                        <td>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow" type="button" id="pastSessionMenu{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="ti ti-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="pastSessionMenu{{ forloop.counter }}">
                              <li>
                                <a class="dropdown-item" href="#">
                                  <i class="ti ti-eye me-1"></i> View Details
                                </a>
                              </li>
                              {% if session.status == 'completed' and not session.has_feedback %}
                                <li>
                                  <a class="dropdown-item" href="{% url 'content:create_feedback' session_type='private' session_id=session.id %}">
                                    <i class="ti ti-message-circle me-1"></i> Leave Feedback
                                  </a>
                                </li>
                              {% endif %}
                              {% if session.recording_url %}
                                <li>
                                  <a class="dropdown-item" href="{{ session.recording_url }}" target="_blank">
                                    <i class="ti ti-player-play me-1"></i> View Recording
                                  </a>
                                </li>
                              {% endif %}
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <div class="d-flex">
                  <i class="ti ti-info-circle me-2"></i>
                  <div>You have no past private sessions.</div>
                </div>
              </div>
            {% endif %}
            
            <h6 class="mb-3">Group Sessions</h6>
            {% if past_group_sessions %}
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Session</th>
                      <th>Instructor</th>
                      <th>Date & Time</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in past_group_sessions %}
                      <tr>
                        <td>
                          <div>
                            <span>{{ session.title }}</span>
                            <div>
                              <span class="badge bg-label-primary">{{ session.language.name }}</span>
                              <span class="badge bg-label-info">{{ session.level.name }}</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            {% if session.instructor.profile_image %}
                              <img src="{{ session.instructor.profile_image.url }}" alt="{{ session.instructor.user.username }}" class="rounded-circle me-2" width="32" height="32">
                            {% else %}
                              <div class="avatar me-2">
                                <div class="avatar-initial rounded-circle bg-label-primary">
                                  <i class="ti ti-user ti-xs"></i>
                                </div>
                              </div>
                            {% endif %}
                            <span>{{ session.instructor.user.username }}</span>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span>{{ session.start_time|date:"D, M d, Y" }}</span>
                            <small class="d-block text-muted">{{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-label-{{ session.status|lower|slugify }}">
                            {{ session.status|title }}
                          </span>
                        </td>
                        <td>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow" type="button" id="pastGroupMenu{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="ti ti-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="pastGroupMenu{{ forloop.counter }}">
                              <li>
                                <a class="dropdown-item" href="{% url 'content:group_session_detail' session_id=session.id %}">
                                  <i class="ti ti-eye me-1"></i> View Details
                                </a>
                              </li>
                              {% if session.status == 'completed' and not session.has_feedback %}
                                <li>
                                  <a class="dropdown-item" href="{% url 'content:create_feedback' session_type='group' session_id=session.id %}">
                                    <i class="ti ti-message-circle me-1"></i> Leave Feedback
                                  </a>
                                </li>
                              {% endif %}
                              {% if session.recording_url %}
                                <li>
                                  <a class="dropdown-item" href="{{ session.recording_url }}" target="_blank">
                                    <i class="ti ti-player-play me-1"></i> View Recording
                                  </a>
                                </li>
                              {% endif %}
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <div class="d-flex">
                  <i class="ti ti-info-circle me-2"></i>
                  <div>You have no past group sessions.</div>
                </div>
              </div>
            {% endif %}
            
            {% if not past_private_sessions and not past_group_sessions %}
              <div class="text-center py-3">
                <p>You don't have any past sessions yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize calendar
    const calendarEl = document.getElementById('sessions-calendar');
    if (calendarEl) {
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        buttonText: {
          today: 'Today'
        },
        dayMaxEvents: true,
        events: [
          {% for session in upcoming_private_sessions %}
          {
            title: 'Private: {{ session.instructor.user.username }}',
            start: '{{ session.start_time|date:"Y-m-d" }}T{{ session.start_time|time:"H:i:s" }}',
            end: '{{ session.end_time|date:"Y-m-d" }}T{{ session.end_time|time:"H:i:s" }}',
            backgroundColor: '#696cff',
            borderColor: '#696cff',
            extendedProps: {
              type: 'private',
              language: '{{ session.language.name }}',
              level: '{{ session.level.name }}'
            }
          },
          {% endfor %}
          
          {% for session in upcoming_group_sessions %}
          {
            title: 'Group: {{ session.title }}',
            start: '{{ session.start_time|date:"Y-m-d" }}T{{ session.start_time|time:"H:i:s" }}',
            end: '{{ session.end_time|date:"Y-m-d" }}T{{ session.end_time|time:"H:i:s" }}',
            backgroundColor: '#03c3ec',
            borderColor: '#03c3ec',
            extendedProps: {
              type: 'group',
              language: '{{ session.language.name }}',
              level: '{{ session.level.name }}'
            }
          },
          {% endfor %}
        ],
        eventClick: function(info) {
          // Show event details
          const eventType = info.event.extendedProps.type;
          const language = info.event.extendedProps.language;
          const level = info.event.extendedProps.level;
          
          // In a real implementation, this would show a modal with event details
          console.log(`Clicked ${eventType} session in ${language} (${level})`);
        }
      });
      
      calendar.render();
      
      // Handle calendar view buttons
      document.getElementById('calendarViewMonth').addEventListener('click', function() {
        calendar.changeView('dayGridMonth');
        
        // Update active state
        document.querySelectorAll('#calendarViewMonth, #calendarViewWeek, #calendarViewDay').forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
      });
      
      document.getElementById('calendarViewWeek').addEventListener('click', function() {
        calendar.changeView('timeGridWeek');
        
        // Update active state
        document.querySelectorAll('#calendarViewMonth, #calendarViewWeek, #calendarViewDay').forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
      });
      
      document.getElementById('calendarViewDay').addEventListener('click', function() {
        calendar.changeView('timeGridDay');
        
        // Update active state
        document.querySelectorAll('#calendarViewMonth, #calendarViewWeek, #calendarViewDay').forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
      });
    }
  });
</script>
{% endblock %}