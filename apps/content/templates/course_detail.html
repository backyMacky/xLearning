{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{{ instructor.username }} - Instructor Profile{% endblock title %}

{% block content %}
<div class="row">
  <!-- Instructor Information -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="d-flex flex-column flex-md-row p-4">
        <div class="col-12 col-md-8">
          <div class="d-flex align-items-center mb-3">
            <a href="{% url 'content:instructor_list' %}" class="text-muted me-2">
              <i class="ti ti-arrow-left"></i> All Instructors
            </a>
            {% for language in instructor.languages %}
              <span class="badge bg-label-primary me-2">{{ language.name }}</span>
            {% endfor %}
            <span class="badge bg-label-success">{{ instructor.rating }} <i class="ti ti-star-filled"></i></span>
          </div>
          
          <h3 class="card-title mb-2">{{ instructor.username }}</h3>
          <p class="text-muted">{% if instructor.profile.title %}{{ instructor.profile.title }}{% else %}Language Instructor{% endif %}</p>
          
          <div class="d-flex align-items-center mb-3">
            <div class="rating">
              {% for i in "12345" %}
                {% if forloop.counter <= instructor.rating %}
                  <i class="ti ti-star-filled text-warning"></i>
                {% else %}
                  <i class="ti ti-star text-muted"></i>
                {% endif %}
              {% endfor %}
              <span class="text-muted ms-1">({{ instructor.review_count }} reviews)</span>
            </div>
            
            <div class="ms-4">
              <i class="ti ti-clock me-1"></i>
              <span>{{ instructor.sessions_completed }} sessions completed</span>
            </div>
            
            <div class="ms-4">
              <i class="ti ti-calendar me-1"></i>
              <span>Member since {{ instructor.date_joined|date:"M Y" }}</span>
            </div>
          </div>
          
          <div class="card-text mb-4">
            <h5>About Me</h5>
            {{ instructor.bio|safe }}
          </div>
          
          <h5 class="mb-3">Session Rate</h5>
          <div class="alert alert-light-primary d-flex align-items-center mb-4">
            <div class="avatar avatar-sm me-3">
              <div class="avatar-initial rounded bg-label-primary">
                <i class="ti ti-currency-dollar"></i>
              </div>
            </div>
            <div>
              <h5 class="mb-0">${{ instructor.hourly_rate }} per hour</h5>
              <small>Private 1-on-1 session</small>
            </div>
          </div>
          
          {% if request.user.is_authenticated and request.user.is_student %}
            <a href="#available-slots" class="btn btn-primary">
              <i class="ti ti-calendar-plus me-1"></i> Book a Session
            </a>
          {% elif not request.user.is_authenticated %}
            <a href="{% url 'account:login' %}?next={{ request.path }}" class="btn btn-primary">
              <i class="ti ti-lock-open me-1"></i> Login to Book
            </a>
          {% endif %}
        </div>
        
        <div class="col-12 col-md-4 mt-4 mt-md-0 d-flex flex-column align-items-center justify-content-center text-center">
          {% if instructor.profile_image %}
            <img src="{{ instructor.profile_image.url }}" alt="{{ instructor.username }}" class="img-fluid rounded-circle" style="max-width: 200px; max-height: 200px; object-fit: cover;">
          {% else %}
            <div class="avatar" style="width: 200px; height: 200px;">
              <div class="avatar-initial rounded-circle bg-label-primary">
                <i class="ti ti-user ti-xxl"></i>
              </div>
            </div>
          {% endif %}
          
          <div class="mt-3">
            <h6 class="mb-1">Languages</h6>
            <div class="d-flex justify-content-center flex-wrap">
              {% for language in instructor.languages %}
                <span class="badge bg-label-primary m-1 px-2 py-1">{{ language.name }}</span>
              {% endfor %}
            </div>
          </div>
          
          <div class="mt-3">
            <h6 class="mb-1">Specializes in</h6>
            <div class="d-flex justify-content-center flex-wrap">
              {% for specialty in instructor.specialties %}
                <span class="badge bg-label-info m-1 px-2 py-1">{{ specialty }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Available Session Times -->
  <div class="col-md-8 mb-4">
    <div class="card h-100" id="available-slots">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title">Available Session Times</h5>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-primary active" data-bs-target="private-slots">Private Sessions</button>
          <button type="button" class="btn btn-outline-primary" data-bs-target="group-slots">Group Sessions</button>
        </div>
      </div>
      
      <!-- Private Sessions -->
      <div class="card-body" id="private-slots">
        {% if available_slots %}
          <div class="row">
            <div class="col-md-4 mb-4">
              <div class="text-center mb-3">
                <h6 class="fw-semibold">Select Date</h6>
              </div>
              <div class="calendar-mini" id="session-calendar"></div>
            </div>
            
            <div class="col-md-8">
              <div class="text-center mb-3">
                <h6 class="fw-semibold">Available Times</h6>
              </div>
              <div id="time-slots-container" class="d-flex flex-wrap gap-2 justify-content-center">
                {% for slot in available_slots %}
                  <div class="time-slot-card" data-date="{{ slot.start_time|date:'Y-m-d' }}">
                    <div class="card border {% if slot.start_time|date:'Y-m-d' == today|date:'Y-m-d' %}border-primary{% endif %}">
                      <div class="card-body p-3 text-center">
                        <h6 class="mb-1">{{ slot.start_time|date:"M d" }}</h6>
                        <span class="d-block mb-2">{{ slot.start_time|time:"H:i" }}</span>
                        <a href="{% url 'booking:book_slot' slot_id=slot.id %}" class="btn btn-sm btn-primary">Book</a>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              
              {% if not available_slots_filtered %}
                <div class="alert alert-info text-center mt-3">
                  <i class="ti ti-calendar-off me-1"></i>
                  <span>No available times for selected date. Please choose another date.</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="text-center py-5">
            <div class="avatar avatar-md mb-3">
              <div class="avatar-initial rounded-circle bg-label-primary">
                <i class="ti ti-calendar-off ti-md"></i>
              </div>
            </div>
            <h6 class="mb-1">No available sessions</h6>
            <p class="mb-3">This instructor doesn't have any available time slots at the moment</p>
            <a href="{% url 'content:instructor_list' %}" class="btn btn-primary">
              <i class="ti ti-users me-1"></i> Browse Other Instructors
            </a>
          </div>
        {% endif %}
      </div>
      
      <!-- Group Sessions -->
      <div class="card-body" id="group-slots" style="display: none;">
        {% if group_sessions %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>Date & Time</th>
                  <th>Duration</th>
                  <th>Enrollment</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for session in group_sessions %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar avatar-sm me-2">
                        <div class="avatar-initial rounded bg-label-primary">
                          <i class="ti ti-users"></i>
                        </div>
                      </div>
                      <div>
                        <h6 class="mb-0">{{ session.title }}</h6>
                        <small class="text-muted">{{ session.language.name }} ({{ session.level.name }})</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div>
                      <h6 class="mb-0">{{ session.start_time|date:"D, M d" }}</h6>
                      <small class="text-muted">{{ session.start_time|time:"H:i" }}</small>
                    </div>
                  </td>
                  <td>{{ session.duration_minutes }} minutes</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="progress flex-grow-1" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {{ session.enrollment_percentage }}%" 
                             aria-valuenow="{{ session.enrollment_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                      <span class="ms-2">{{ session.students.count }}/{{ session.max_students }}</span>
                    </div>
                  </td>
                  <td>
                    {% if session.is_full %}
                      <button disabled class="btn btn-sm btn-outline-secondary">
                        <i class="ti ti-users-off me-1"></i> Full
                      </button>
                    {% elif session.is_enrolled %}
                      <a href="{% url 'content:group_session_detail' session_id=session.id %}" class="btn btn-sm btn-outline-success">
                        <i class="ti ti-check me-1"></i> Enrolled
                      </a>
                    {% else %}
                      <a href="{% url 'booking:enroll_group_session' session_id=session.id %}" class="btn btn-sm btn-primary">
                        <i class="ti ti-user-plus me-1"></i> Join
                      </a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <div class="avatar avatar-md mb-3">
              <div class="avatar-initial rounded-circle bg-label-primary">
                <i class="ti ti-users ti-md"></i>
              </div>
            </div>
            <h6 class="mb-1">No group sessions available</h6>
            <p class="mb-3">This instructor doesn't have any upcoming group sessions at the moment</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Instructor Details Sidebar -->
  <div class="col-md-4 mb-4">
    <!-- Reviews Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title">Student Reviews</h5>
      </div>
      <div class="card-body">
        {% if reviews %}
          {% for review in reviews %}
            <div class="d-flex mb-3 {% if not forloop.last %}pb-3 border-bottom{% endif %}">
              <div class="avatar flex-shrink-0 me-3">
                {% if review.student.profile_image %}
                  <img src="{{ review.student.profile_image.url }}" alt="{{ review.student.username }}" class="rounded-circle">
                {% else %}
                  <div class="avatar-initial rounded-circle bg-label-{{ forloop.counter|divisibleby:3|yesno:"primary,success,info" }}">
                    <i class="ti ti-user"></i>
                  </div>
                {% endif %}
              </div>
              <div>
                <div class="d-flex align-items-center mb-1">
                  <h6 class="mb-0 me-2">{{ review.student.username }}</h6>
                  <div class="rating">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}
                        <i class="ti ti-star-filled text-warning ti-xs"></i>
                      {% else %}
                        <i class="ti ti-star text-muted ti-xs"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
                <small class="text-muted mb-2 d-block">{{ review.created_at|date:"M d, Y" }}</small>
                <p class="mb-0">{{ review.comment }}</p>
              </div>
            </div>
          {% endfor %}
          {% if review_count > 3 %}
            <div class="text-center mt-3">
              <a href="{% url 'content:instructor_reviews' username=instructor.username %}" class="btn btn-sm btn-outline-primary">
                See All {{ review_count }} Reviews
              </a>
            </div>
          {% endif %}
        {% else %}
          <div class="text-center py-3">
            <div class="avatar avatar-md mb-3">
              <div class="avatar-initial rounded-circle bg-label-primary">
                <i class="ti ti-message-circle ti-md"></i>
              </div>
            </div>
            <h6 class="mb-1">No reviews yet</h6>
            <p class="mb-0">This instructor doesn't have any reviews yet</p>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Qualification & Experience Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title">Qualifications & Experience</h5>
      </div>
      <div class="card-body">
        {% if instructor.qualifications %}
          <h6 class="fw-semibold mb-2">Certifications</h6>
          <ul class="mb-4">
            {% for qualification in instructor.qualifications %}
              <li class="mb-1">{{ qualification.title }} {% if qualification.year %}({{ qualification.year }}){% endif %}</li>
            {% endfor %}
          </ul>
        {% endif %}
        
        {% if instructor.experience %}
          <h6 class="fw-semibold mb-2">Teaching Experience</h6>
          <ul class="mb-0">
            {% for experience in instructor.experience %}
              <li class="mb-1">{{ experience.position }} at {{ experience.institution }} ({{ experience.years }})</li>
            {% endfor %}
          </ul>
        {% endif %}
        
        {% if not instructor.qualifications and not instructor.experience %}
          <div class="text-center py-3">
            <p class="mb-0">No qualification information available</p>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Teaching Style Card -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title">Teaching Style</h5>
      </div>
      <div class="card-body">
        {% if instructor.teaching_style %}
          <p>{{ instructor.teaching_style }}</p>
        {% else %}
          <div class="text-center py-3">
            <p class="mb-0">No teaching style information available</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle between private and group sessions
    const privateBtn = document.querySelector('[data-bs-target="private-slots"]');
    const groupBtn = document.querySelector('[data-bs-target="group-slots"]');
    const privateSlots = document.getElementById('private-slots');
    const groupSlots = document.getElementById('group-slots');
    
    privateBtn.addEventListener('click', function() {
      privateBtn.classList.add('active');
      groupBtn.classList.remove('active');
      privateSlots.style.display = 'block';
      groupSlots.style.display = 'none';
    });
    
    groupBtn.addEventListener('click', function() {
      groupBtn.classList.add('active');
      privateBtn.classList.remove('active');
      groupSlots.style.display = 'block';
      privateSlots.style.display = 'none';
    });
    
    // Filter time slots by date when calendar date is clicked
    if (document.getElementById('session-calendar')) {
      const timeSlots = document.querySelectorAll('.time-slot-card');
      const dates = [...new Set([...timeSlots].map(slot => slot.dataset.date))];
      
      // Initialize mini calendar (this would use a calendar library in a real implementation)
      // For demo purposes, we'll just create date buttons
      const calendarContainer = document.getElementById('session-calendar');
      
      dates.forEach(date => {
        const dateObj = new Date(date);
        const dateBtn = document.createElement('button');
        dateBtn.className = 'btn btn-sm ' + 
          (date === '{{ today|date:"Y-m-d" }}' ? 'btn-primary' : 'btn-outline-primary');
        dateBtn.style.margin = '3px';
        dateBtn.innerHTML = dateObj.getDate();
        dateBtn.setAttribute('data-date', date);
        
        dateBtn.addEventListener('click', function() {
          document.querySelectorAll('#session-calendar button').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
          });
          this.classList.remove('btn-outline-primary');
          this.classList.add('btn-primary');
          
          const selectedDate = this.dataset.date;
          
          // Show/hide slots based on date
          timeSlots.forEach(slot => {
            if (slot.dataset.date === selectedDate) {
              slot.style.display = 'block';
            } else {
              slot.style.display = 'none';
            }
          });
          
          // Check if any slots visible
          const visibleSlots = [...timeSlots].filter(slot => 
            slot.dataset.date === selectedDate && slot.style.display !== 'none');
          
          if (visibleSlots.length === 0) {
            document.getElementById('no-slots-message') ? null : 
              document.getElementById('time-slots-container').insertAdjacentHTML('beforeend', 
                '<div id="no-slots-message" class="alert alert-info text-center mt-3 w-100">' +
                '<i class="ti ti-calendar-off me-1"></i>' +
                '<span>No available times for this date. Please select another date.</span></div>');
          } else {
            document.getElementById('no-slots-message')?.remove();
          }
        });
        
        calendarContainer.appendChild(dateBtn);
      });
      
      // Trigger click on today's date if available, otherwise the first date
      const todayBtn = document.querySelector(`[data-date="{{ today|date:'Y-m-d' }}"]`);
      if (todayBtn) {
        todayBtn.click();
      } else if (dates.length > 0) {
        document.querySelector(`[data-date="${dates[0]}"]`).click();
      }
    }
  });
</script>
{% endblock %}