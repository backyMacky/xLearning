{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{{ title }} - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/spinkit/spinkit.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title">{{ title }}</h5>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          
          <!-- Hidden AI fields -->
          {{ form.use_ai }}
          {{ form.ai_prompt }}
          {{ form.ai_tone }}
          
          {% if form.errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="{{ form.title.id_for_label }}" class="form-label">Resource Title</label>
              <div class="input-group">
                {{ form.title }}
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiTitleModal">
                  <i class="ti ti-bulb me-1"></i> AI Assist
                </button>
              </div>
              {% if form.title.errors %}
                <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label for="{{ form.resource_type.id_for_label }}" class="form-label">Resource Type</label>
              {{ form.resource_type }}
              {% if form.resource_type.errors %}
                <div class="invalid-feedback d-block">{{ form.resource_type.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
            <div class="input-group">
              {{ form.description }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiDescriptionModal">
                <i class="ti ti-bulb me-1"></i> AI Assist
              </button>
            </div>
            {% if form.description.errors %}
              <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="{{ form.language.id_for_label }}" class="form-label">Language</label>
              {{ form.language }}
              {% if form.language.errors %}
                <div class="invalid-feedback d-block">{{ form.language.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label for="{{ form.level.id_for_label }}" class="form-label">Level</label>
              {{ form.level }}
              {% if form.level.errors %}
                <div class="invalid-feedback d-block">{{ form.level.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6" id="fileUploadContainer">
              <label for="{{ form.file.id_for_label }}" class="form-label">Upload File</label>
              {{ form.file }}
              {% if form.file.errors %}
                <div class="invalid-feedback d-block">{{ form.file.errors.0 }}</div>
              {% endif %}
              {% if form.instance.file %}
                <div class="mt-2">
                  <span class="badge bg-label-info">Current file: {{ form.instance.file.name|cut:"teacher_resources/" }}</span>
                </div>
              {% endif %}
            </div>
            <div class="col-md-6" id="externalUrlContainer">
              <label for="{{ form.external_url.id_for_label }}" class="form-label">External URL</label>
              {{ form.external_url }}
              {% if form.external_url.errors %}
                <div class="invalid-feedback d-block">{{ form.external_url.errors.0 }}</div>
              {% endif %}
              <small class="text-muted">For external resources like websites, videos, etc.</small>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="{{ form.course.id_for_label }}" class="form-label">Associated Course (optional)</label>
              {{ form.course }}
              {% if form.course.errors %}
                <div class="invalid-feedback d-block">{{ form.course.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6" id="lessonContainer">
              <label for="{{ form.lesson.id_for_label }}" class="form-label">Associated Lesson (optional)</label>
              {{ form.lesson }}
              {% if form.lesson.errors %}
                <div class="invalid-feedback d-block">{{ form.lesson.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              {{ form.is_public }}
              <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                Make Resource Public
              </label>
              <div class="text-muted small">If checked, this resource will be available to all enrolled students in the associated course. Otherwise, you'll need to share it manually.</div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'content:resource_list' %}" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- AI Title Generator Modal -->
<div class="modal fade" id="aiTitleModal" tabindex="-1" aria-labelledby="aiTitleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiTitleModalLabel">Generate Resource Title with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="titlePrompt" class="form-label">Describe your resource</label>
          <textarea id="titlePrompt" class="form-control" rows="3" placeholder="Briefly describe what your resource is about, its purpose, and target audience."></textarea>
        </div>
        
        <div class="mb-3">
          <label for="titleTone" class="form-label">Tone</label>
          <select id="titleTone" class="form-select">
            <option value="professional" selected>Professional</option>
            <option value="academic">Academic</option>
            <option value="friendly">Friendly</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="concise">Concise</option>
          </select>
        </div>
        
        <div id="titleGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating title suggestions...</p>
        </div>
        
        <div id="titleResults" class="d-none">
          <label class="form-label">Choose a title:</label>
          <div class="title-suggestions"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="generateTitleBtn">Generate Titles</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Description Generator Modal -->
<div class="modal fade" id="aiDescriptionModal" tabindex="-1" aria-labelledby="aiDescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiDescriptionModalLabel">Generate Resource Description with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="descriptionPrompt" class="form-label">What would you like to generate?</label>
          <textarea id="descriptionPrompt" class="form-control" rows="4" placeholder="Describe the content of your resource, including key features, benefits for students, and how it relates to language learning."></textarea>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="descriptionTone" class="form-label">Tone</label>
            <select id="descriptionTone" class="form-select">
              <option value="professional" selected>Professional</option>
              <option value="academic">Academic</option>
              <option value="friendly">Friendly</option>
              <option value="enthusiastic">Enthusiastic</option>
              <option value="concise">Concise</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="descriptionLength" class="form-label">Length</label>
            <select id="descriptionLength" class="form-select">
              <option value="150">Short</option>
              <option value="250" selected>Medium</option>
              <option value="400">Long</option>
            </select>
          </div>
        </div>
        
        <div id="descriptionGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating description... This may take a moment.</p>
        </div>
        
        <div id="descriptionResults" class="d-none">
          <label class="form-label">Generated Description:</label>
          <div class="card">
            <div class="card-body">
              <div id="descriptionPreview" class="border p-3 rounded bg-light" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success d-none" id="useDescriptionBtn">Use This Description</button>
        <button type="button" class="btn btn-primary" id="generateDescriptionBtn">Generate Description</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token for API requests
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Initialize select2 for dropdowns
    $('.form-select').select2();
    
    // Handle resource type changes to show/hide relevant fields
    const resourceTypeField = document.querySelector('#{{ form.resource_type.id_for_label }}');
    const fileUploadContainer = document.getElementById('fileUploadContainer');
    const externalUrlContainer = document.getElementById('externalUrlContainer');
    
    function updateFieldVisibility() {
      const resourceType = resourceTypeField.value;
      
      if (resourceType === 'link') {
        // Link type - show URL field, hide file upload
        fileUploadContainer.style.display = 'none';
        externalUrlContainer.style.display = 'block';
      } else {
        // Other types - show both, file upload is primary
        fileUploadContainer.style.display = 'block';
        externalUrlContainer.style.display = 'block';
      }
    }
    
    // Initial update
    updateFieldVisibility();
    
    // Update on changes
    resourceTypeField.addEventListener('change', updateFieldVisibility);
    
    // Handle course selection to filter lessons
    const courseField = document.querySelector('#{{ form.course.id_for_label }}');
    const lessonField = document.querySelector('#{{ form.lesson.id_for_label }}');
    const lessonContainer = document.getElementById('lessonContainer');
    
    function updateLessonOptions() {
      const courseId = courseField.value;
      
      if (!courseId) {
        // No course selected, hide lesson field
        lessonContainer.style.display = 'none';
        return;
      }
      
      // Show lesson field
      lessonContainer.style.display = 'block';
      
      // Clear current options
      lessonField.innerHTML = '<option value="">---------</option>';
      
      // Fetch lessons for selected course
      fetch(`/api/courses/${courseId}/lessons/`)
        .then(response => response.json())
        .then(data => {
          // Add lesson options
          data.forEach(lesson => {
            const option = document.createElement('option');
            option.value = lesson.id;
            option.textContent = lesson.title;
            lessonField.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching lessons:', error);
        });
    }
    
    // Initial update
    if (courseField.value) {
      lessonContainer.style.display = 'block';
    } else {
      lessonContainer.style.display = 'none';
    }
    
    // Update on changes
    courseField.addEventListener('change', updateLessonOptions);

    // Generate AI Title
    const generateTitleBtn = document.getElementById('generateTitleBtn');
    generateTitleBtn.addEventListener('click', function() {
      const prompt = document.getElementById('titlePrompt').value;
      const tone = document.getElementById('titleTone').value;
      
      if (!prompt) {
        alert('Please describe your resource before generating titles.');
        return;
      }
      
      // Set AI fields in form for backend processing
      document.querySelector('#{{ form.use_ai.id_for_label }}').value = 'true';
      document.querySelector('#{{ form.ai_prompt.id_for_label }}').value = prompt;
      document.querySelector('#{{ form.ai_tone.id_for_label }}').value = tone;
      
      // Show loading indicator
      document.getElementById('titleGenerating').classList.remove('d-none');
      document.getElementById('titleResults').classList.add('d-none');
      generateTitleBtn.disabled = true;
      
      // Prepare the actual prompt
      const titlePrompt = `Generate 3 concise, descriptive titles for a ${resourceTypeField.options[resourceTypeField.selectedIndex].text.toLowerCase()} resource about: ${prompt}. Each title should clearly communicate the content and purpose of the resource.`;
      
      // Call the API
      fetch('{% url "content:api_generate_suggestions" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          text: titlePrompt,
          suggestion_count: 3,
          max_tokens: 100
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('titleGenerating').classList.add('d-none');
        document.getElementById('titleResults').classList.remove('d-none');
        generateTitleBtn.disabled = false;
        
        if (data.error) {
          document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        const suggestionsContainer = document.querySelector('.title-suggestions');
        suggestionsContainer.innerHTML = '';
        
        // Create buttons for each suggestion
        data.suggestions.forEach((title, index) => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-outline-primary w-100 mb-2 text-start';
          btn.innerHTML = title;
          btn.addEventListener('click', function() {
            // Set the title in the form
            document.getElementById('{{ form.title.id_for_label }}').value = title;
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('aiTitleModal')).hide();
          });
          suggestionsContainer.appendChild(btn);
        });
      })
      .catch(error => {
        document.getElementById('titleGenerating').classList.add('d-none');
        document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateTitleBtn.disabled = false;
      });
    });
    
    // Generate AI Description
    const generateDescriptionBtn = document.getElementById('generateDescriptionBtn');
    const useDescriptionBtn = document.getElementById('useDescriptionBtn');
    let generatedDescription = '';
    
    generateDescriptionBtn.addEventListener('click', function() {
      const prompt = document.getElementById('descriptionPrompt').value;
      const tone = document.getElementById('descriptionTone').value;
      const maxTokens = document.getElementById('descriptionLength').value;
      
      if (!prompt) {
        alert('Please describe what content you would like to generate.');
        return;
      }
      
      // Show loading indicator
      document.getElementById('descriptionGenerating').classList.remove('d-none');
      document.getElementById('descriptionResults').classList.add('d-none');
      useDescriptionBtn.classList.add('d-none');
      generateDescriptionBtn.disabled = true;
      
      // Prepare resource type context
      const resourceType = resourceTypeField.options[resourceTypeField.selectedIndex].text.toLowerCase();
      
      // Prepare the actual prompt
      const descriptionPrompt = `Write a compelling description for a ${resourceType} resource with the following details: ${prompt}. The description should clearly explain what the resource contains, who it's for, and why it's valuable for language learners.`;
      
      // Call the API
      fetch('{% url "content:api_generate_text" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          prompt: descriptionPrompt,
          tone: tone,
          max_tokens: parseInt(maxTokens)
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionResults').classList.remove('d-none');
        generateDescriptionBtn.disabled = false;
        useDescriptionBtn.classList.remove('d-none');
        
        if (data.error) {
          document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        // Store the generated content
        generatedDescription = data.text;
        
        // Display the generated content
        document.getElementById('descriptionPreview').innerHTML = generatedDescription.replace(/\n/g, '<br>');
      })
      .catch(error => {
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateDescriptionBtn.disabled = false;
      });
    });
    
    // Use the generated description
    useDescriptionBtn.addEventListener('click', function() {
      // Set the content in the form
      document.getElementById('{{ form.description.id_for_label }}').value = generatedDescription;
      
      // Close the modal
      bootstrap.Modal.getInstance(document.getElementById('aiDescriptionModal')).hide();
    });
  });
</script>
{% endblock %}