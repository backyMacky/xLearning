{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{{ title }} - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/spinkit/spinkit.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <a href="{% url 'content:course_detail' slug=course.slug %}" class="me-2">
          <i class="ti ti-arrow-left"></i>
        </a>
        <h5 class="card-title mb-0">{{ title }}</h5>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <!-- Hidden AI fields -->
          {{ form.use_ai }}
          {{ form.ai_prompt }}
          {{ form.ai_tone }}
          
          {% if form.errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          
          <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">Module Title</label>
            <div class="input-group">
              {{ form.title }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiTitleModal">
                <i class="ti ti-bulb me-1"></i> AI Assist
              </button>
            </div>
            {% if form.title.errors %}
              <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
            <div class="input-group">
              {{ form.description }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiDescriptionModal">
                <i class="ti ti-bulb me-1"></i> AI Assist
              </button>
            </div>
            {% if form.description.errors %}
              <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
            {% endif %}
            <small class="text-muted">Optional: Provide a brief overview of this module.</small>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.order.id_for_label }}" class="form-label">Order</label>
            {{ form.order }}
            {% if form.order.errors %}
              <div class="invalid-feedback d-block">{{ form.order.errors.0 }}</div>
            {% endif %}
            <small class="text-muted">Display order in the course (lower values appear first)</small>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'content:course_detail' slug=course.slug %}" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- AI Title Generator Modal -->
<div class="modal fade" id="aiTitleModal" tabindex="-1" aria-labelledby="aiTitleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiTitleModalLabel">Generate Module Title with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="titlePrompt" class="form-label">Describe your module</label>
          <textarea id="titlePrompt" class="form-control" rows="3" placeholder="Briefly describe what this module will cover"></textarea>
        </div>
        
        <div class="mb-3">
          <label for="titleTone" class="form-label">Tone</label>
          <select id="titleTone" class="form-select">
            <option value="professional">Professional</option>
            <option value="academic">Academic</option>
            <option value="friendly" selected>Friendly</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="concise">Concise</option>
          </select>
        </div>
        
        <div id="titleGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating title suggestions...</p>
        </div>
        
        <div id="titleResults" class="d-none">
          <label class="form-label">Choose a title:</label>
          <div class="title-suggestions"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="generateTitleBtn">Generate Titles</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Description Generator Modal -->
<div class="modal fade" id="aiDescriptionModal" tabindex="-1" aria-labelledby="aiDescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiDescriptionModalLabel">Generate Module Description with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="descriptionPrompt" class="form-label">What would you like to generate?</label>
          <textarea id="descriptionPrompt" class="form-control" rows="3" placeholder="Describe what topics this module covers, its learning goals, and its place in the course"></textarea>
        </div>
        
        <div class="mb-3">
          <label for="descriptionTone" class="form-label">Tone</label>
          <select id="descriptionTone" class="form-select">
            <option value="professional">Professional</option>
            <option value="academic">Academic</option>
            <option value="friendly" selected>Friendly</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="concise">Concise</option>
          </select>
        </div>
        
        <div id="descriptionGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating description...</p>
        </div>
        
        <div id="descriptionResults" class="d-none">
          <label class="form-label">Generated Description:</label>
          <div class="card">
            <div class="card-body">
              <div id="descriptionPreview" class="border p-3 rounded bg-light" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success d-none" id="useDescriptionBtn">Use This Description</button>
        <button type="button" class="btn btn-primary" id="generateDescriptionBtn">Generate Description</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token for API requests
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Initialize select2 for dropdowns if any
    if (document.querySelector('.select2')) {
      $('.select2').select2();
    }
    
    // Generate AI Title
    const generateTitleBtn = document.getElementById('generateTitleBtn');
    generateTitleBtn.addEventListener('click', function() {
      const prompt = document.getElementById('titlePrompt').value;
      const tone = document.getElementById('titleTone').value;
      
      if (!prompt) {
        alert('Please enter a description of your module.');
        return;
      }
      
      // Show loading indicator
      document.getElementById('titleGenerating').classList.remove('d-none');
      document.getElementById('titleResults').classList.add('d-none');
      generateTitleBtn.disabled = true;
      
      // Prepare the actual prompt
      const titlePrompt = `Generate 3 concise, clear titles for a learning module about: ${prompt}. Each title should be descriptive but brief, clearly indicating what students will learn in this module.`;
      
      // Call the API
      fetch('{% url "content:api_generate_suggestions" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          text: titlePrompt,
          suggestion_count: 3,
          max_tokens: 100
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('titleGenerating').classList.add('d-none');
        document.getElementById('titleResults').classList.remove('d-none');
        generateTitleBtn.disabled = false;
        
        if (data.error) {
          document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        const suggestionsContainer = document.querySelector('.title-suggestions');
        suggestionsContainer.innerHTML = '';
        
        // Create buttons for each suggestion
        data.suggestions.forEach((title, index) => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-outline-primary w-100 mb-2 text-start';
          btn.innerHTML = title;
          btn.addEventListener('click', function() {
            // Set the title in the form
            document.getElementById('{{ form.title.id_for_label }}').value = title;
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('aiTitleModal')).hide();
          });
          suggestionsContainer.appendChild(btn);
        });
      })
      .catch(error => {
        document.getElementById('titleGenerating').classList.add('d-none');
        document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateTitleBtn.disabled = false;
      });
    });
    
    // Generate AI Description
    const generateDescriptionBtn = document.getElementById('generateDescriptionBtn');
    const useDescriptionBtn = document.getElementById('useDescriptionBtn');
    let generatedDescription = '';
    
    generateDescriptionBtn.addEventListener('click', function() {
      const prompt = document.getElementById('descriptionPrompt').value;
      const tone = document.getElementById('descriptionTone').value;
      
      if (!prompt) {
        alert('Please describe what content you would like to generate.');
        return;
      }
      
      // Show loading indicator
      document.getElementById('descriptionGenerating').classList.remove('d-none');
      document.getElementById('descriptionResults').classList.add('d-none');
      useDescriptionBtn.classList.add('d-none');
      generateDescriptionBtn.disabled = true;
      
      // Prepare the actual prompt
      const descriptionPrompt = `Write a brief, clear description for a learning module with the following details: ${prompt}. The description should explain what students will learn in this module and how it fits into the overall course.`;
      
      // Call the API
      fetch('{% url "content:api_generate_text" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          prompt: descriptionPrompt,
          tone: tone,
          max_tokens: 200
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionResults').classList.remove('d-none');
        generateDescriptionBtn.disabled = false;
        useDescriptionBtn.classList.remove('d-none');
        
        if (data.error) {
          document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        // Store the generated content
        generatedDescription = data.text;
        
        // Display the generated content
        document.getElementById('descriptionPreview').innerHTML = generatedDescription.replace(/\n/g, '<br>');
      })
      .catch(error => {
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateDescriptionBtn.disabled = false;
      });
    });
    
    // Use the generated description
    useDescriptionBtn.addEventListener('click', function() {
      // Set the description in the form
      document.getElementById('{{ form.description.id_for_label }}').value = generatedDescription;
      
      // Close the modal
      bootstrap.Modal.getInstance(document.getElementById('aiDescriptionModal')).hide();
    });
  });
</script>
{% endblock %}