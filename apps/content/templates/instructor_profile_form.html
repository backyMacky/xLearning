{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{{ title }} - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">{{ title }}</h5>
        <a href="{% url 'content:instructor_dashboard' %}" class="btn btn-outline-primary btn-sm">
          <i class="ti ti-arrow-left me-1"></i> Back to Dashboard
        </a>
      </div>

      <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="instructorProfileForm">
          {% csrf_token %}

          {% if form.errors %}
          <div class="alert alert-danger">
            <div class="alert-body">
              Please correct the errors below:
              <ul class="mb-0 mt-1">
                {% for field in form %}
                  {% if field.errors %}
                    {% for error in field.errors %}
                      <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

          <div class="row g-4">
            <!-- Left Column -->
            <div class="col-lg-4">
              <div class="card shadow-none border">
                <div class="card-header">
                  <h6 class="mb-0">Profile Image</h6>
                </div>
                <div class="card-body text-center">
                  <div class="profile-image-container mb-3">
                    {% if form.instance.profile_image %}
                      <img src="{{ form.instance.profile_image.url }}" alt="Profile Preview" id="profile-preview" class="rounded-circle shadow-sm" style="width: 180px; height: 180px; object-fit: cover;">
                    {% else %}
                      <div id="profile-preview-placeholder" class="avatar avatar-xl">
                        <div class="avatar-initial rounded-circle bg-label-primary" style="width: 180px; height: 180px;">
                          <i class="ti ti-user" style="font-size: 4rem;"></i>
                        </div>
                      </div>
                      <img src="" alt="Profile Preview" id="profile-preview" class="rounded-circle shadow-sm d-none" style="width: 180px; height: 180px; object-fit: cover;">
                    {% endif %}
                  </div>
                  
                  <div class="mb-3">
                    <div class="btn btn-primary btn-sm position-relative">
                      <i class="ti ti-upload me-1"></i> Upload Photo
                      <input type="file" id="{{ form.profile_image.id_for_label }}" name="{{ form.profile_image.name }}" 
                             class="position-absolute top-0 start-0 opacity-0 width-100 height-100" 
                             style="cursor: pointer; width: 100%; height: 100%;" accept="image/*">
                    </div>
                    <div id="image-feedback" class="mt-2"></div>
                    {% if form.profile_image.errors %}
                      <div class="invalid-feedback d-block small mt-1">{{ form.profile_image.errors.0 }}</div>
                    {% endif %}
                  </div>
                  <small class="text-muted">Recommended: Square image, 300x300px or larger</small>
                </div>
              </div>
              
              <!-- Availability Status Card -->
              <div class="card shadow-none border mt-3">
                <div class="card-header">
                  <h6 class="mb-0">Availability</h6>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch">
                    {{ form.is_available }}
                    <label class="form-check-label" for="{{ form.is_available.id_for_label }}">
                      Available for booking
                    </label>
                  </div>
                  <small class="text-muted">Toggle your availability status for students</small>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-8">
              <!-- Languages & Proficiencies -->
              <div class="card shadow-none border mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Language Information</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <!-- Primary Teaching Language -->
                    <div class="col-md-6">
                      <label for="primary_language" class="form-label">Teaching Language</label>
                      <select id="primary_language" name="primary_language" class="form-select">
                        <option value="">Select Language</option>
                        <option value="English" {% if form.primary_language.value == "English" %}selected{% endif %}>English</option>
                        <option value="French" {% if form.primary_language.value == "French" %}selected{% endif %}>French</option>
                        <option value="Spanish" {% if form.primary_language.value == "Spanish" %}selected{% endif %}>Spanish</option>
                        <option value="Swahili" {% if form.primary_language.value == "Swahili" %}selected{% endif %}>Swahili</option>
                      </select>
                    </div>

                    <!-- Teaching Level -->
                    <div class="col-md-6">
                      <label for="{{ form.teaching_level.id_for_label }}" class="form-label">Teaching Level</label>
                      <select id="{{ form.teaching_level.id_for_label }}" name="{{ form.teaching_level.name }}" class="form-select">
                        <option value="">Select Level</option>
                        <option value="A1" {% if form.teaching_level.value == "A1" %}selected{% endif %}>A1 - Beginner</option>
                        <option value="A2" {% if form.teaching_level.value == "A2" %}selected{% endif %}>A2 - Elementary</option>
                        <option value="B1" {% if form.teaching_level.value == "B1" %}selected{% endif %}>B1 - Intermediate</option>
                        <option value="B2" {% if form.teaching_level.value == "B2" %}selected{% endif %}>B2 - Upper Intermediate</option>
                        <option value="C1" {% if form.teaching_level.value == "C1" %}selected{% endif %}>C1 - Advanced</option>
                        <option value="C2" {% if form.teaching_level.value == "C2" %}selected{% endif %}>C2 - Proficient</option>
                        <option value="All" {% if form.teaching_level.value == "All" %}selected{% endif %}>All Levels</option>
                      </select>
                      {% if form.teaching_level.errors %}
                        <div class="invalid-feedback d-block">{{ form.teaching_level.errors.0 }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Proficiencies Card -->
              <div class="card shadow-none border mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Teaching Proficiencies</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <!-- Teaching Proficiencies -->
                    <div class="col-md-12">
                      <label class="form-label">Select Your Teaching Proficiencies</label>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proficiency_vocabulary" name="proficiencies[]" value="vocabulary" 
                          {% if "vocabulary" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_vocabulary">Vocabulary</label>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proficiency_pronunciation" name="proficiencies[]" value="pronunciation" 
                          {% if "pronunciation" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_pronunciation">Pronunciation</label>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proficiency_grammar" name="proficiencies[]" value="grammar" 
                          {% if "grammar" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_grammar">Grammar</label>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proficiency_conversation" name="proficiencies[]" value="conversation" 
                          {% if "conversation" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_conversation">Conversation</label>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proficiency_writing" name="proficiencies[]" value="writing" 
                          {% if "writing" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_writing">Writing</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="proficiency_reading" name="proficiencies[]" value="reading" 
                          {% if "reading" in selected_proficiencies %}checked{% endif %}>
                        <label class="form-check-label" for="proficiency_reading">Reading</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Specialties Card -->
              <div class="card shadow-none border mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Specialties</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <!-- Specialties Selection as Dropdown -->
                    <div class="col-md-12">
                      <label for="specialty" class="form-label">Teaching Specialty</label>
                      <select id="specialty" name="specialty" class="form-select">
                        <option value="">Select Specialty</option>
                        <option value="business" {% if "business" in selected_specialties %}selected{% endif %}>Business English</option>
                        <option value="academic" {% if "academic" in selected_specialties %}selected{% endif %}>Academic English</option>
                        <option value="conversation" {% if "conversation" in selected_specialties %}selected{% endif %}>Conversation Practice</option>
                        <option value="exam" {% if "exam" in selected_specialties %}selected{% endif %}>Exam Preparation</option>
                        <option value="children" {% if "children" in selected_specialties %}selected{% endif %}>Teaching Children</option>
                        <option value="medical" {% if "medical" in selected_specialties %}selected{% endif %}>Medical English</option>
                      </select>
                      {% if form.specialties.errors %}
                        <div class="invalid-feedback d-block">{{ form.specialties.errors.0 }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Bio & Teaching Style -->
              <div class="card shadow-none border">
                <div class="card-header">
                  <h6 class="mb-0">Instructor Information</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <!-- Professional Bio -->
                    <div class="col-md-12">
                      <label for="{{ form.bio.id_for_label }}" class="form-label">Professional Bio</label>
                      <textarea id="{{ form.bio.id_for_label }}" name="{{ form.bio.name }}" class="form-control" 
                                rows="2" style="resize: none; border-color: #d9dee3; border-radius: 0.375rem; padding: 0.75rem;">{{ form.bio.value|default:'' }}</textarea>
                      {% if form.bio.errors %}
                        <div class="invalid-feedback d-block">{{ form.bio.errors.0 }}</div>
                      {% endif %}
                    </div>

                    <!-- Teaching Style -->
                    <div class="col-md-12">
                      <label for="{{ form.teaching_style.id_for_label }}" class="form-label">Teaching Style</label>
                      <textarea id="{{ form.teaching_style.id_for_label }}" name="{{ form.teaching_style.name }}" class="form-control" 
                                rows="3" style="resize: none; border-color: #d9dee3; border-radius: 0.375rem; padding: 0.75rem;">{{ form.teaching_style.value|default:'' }}</textarea>
                      {% if form.teaching_style.errors %}
                        <div class="invalid-feedback d-block">{{ form.teaching_style.errors.0 }}</div>
                      {% endif %}
                    </div>
                    
                    <!-- Hourly Rate (hidden with default value) -->
                    <input type="hidden" id="{{ form.hourly_rate.id_for_label }}" name="{{ form.hourly_rate.name }}" value="25.00">
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="col-12 d-flex justify-content-end gap-2 mt-2">
              <a href="{% url 'content:instructor_dashboard' %}" class="btn btn-outline-secondary">
                <i class="ti ti-x me-1"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-device-floppy me-1"></i> {{ submit_text|default:"Save Profile" }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for dropdowns
    $('.select2').select2({
      placeholder: "Select options",
      allowClear: true,
      width: '100%'
    });
    
    // Enhanced Image preview with immediate feedback
    const profileInput = document.getElementById('{{ form.profile_image.id_for_label }}');
    const profilePreview = document.getElementById('profile-preview');
    const profilePlaceholder = document.getElementById('profile-preview-placeholder');
    const feedbackDiv = document.getElementById('image-feedback');
    
    if (profileInput && profilePreview) {
      profileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          
          // Before the image loads, show loading indicator
          feedbackDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Loading preview...';
          
          reader.onload = function(e) {
            // Show the image preview immediately
            profilePreview.setAttribute('src', e.target.result);
            profilePreview.classList.remove('d-none');
            
            // Hide the placeholder if it exists
            if (profilePlaceholder) {
              profilePlaceholder.classList.add('d-none');
            }
            
            // Show success message in the feedback div
            feedbackDiv.innerHTML = '<div class="text-success"><i class="ti ti-check me-1"></i>Image uploaded successfully!</div>';
            
            // Remove the message after 3 seconds
            setTimeout(() => {
              feedbackDiv.innerHTML = '';
            }, 3000);
          };
          
          // Handle potential errors
          reader.onerror = function() {
            feedbackDiv.innerHTML = '<div class="text-danger"><i class="ti ti-alert-triangle me-1"></i>Error loading image.</div>';
          };
          
          // Start reading the file as a data URL (base64 encoded string)
          reader.readAsDataURL(this.files[0]);
        }
      });
    }
  });
</script>
{% endblock %}