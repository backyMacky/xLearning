{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Write a Review for {{ instructor.user.username }} - Learning Platform{% endblock title %}

{% block content %}
<div class="row">
  <div class="col-12 col-md-8 col-lg-6 mx-auto">
    <div class="card">
      <div class="card-header d-flex justify-content-between">
        <h5 class="card-title mb-0">{{ title }}</h5>
        <a href="{% url 'content:instructor_detail' username=instructor.user.username %}" class="btn btn-outline-primary btn-sm">
          <i class="ti ti-arrow-left me-1"></i> Back to Profile
        </a>
      </div>
      
      <div class="card-body">
        <!-- Instructor Info -->
        <div class="d-flex align-items-center border-bottom pb-3 mb-4">
          <div class="flex-shrink-0 me-3">
            {% if instructor.profile_image %}
              <img src="{{ instructor.profile_image.url }}" alt="{{ instructor.user.username }}" class="rounded-circle" width="60" height="60" style="object-fit: cover;">
            {% else %}
              <div class="avatar">
                <div class="avatar-initial rounded-circle bg-label-primary">
                  <i class="ti ti-user"></i>
                </div>
              </div>
            {% endif %}
          </div>
          <div>
            <h6 class="mb-0">{{ instructor.user.username }}</h6>
            <div class="d-flex mt-1">
              {% for language in instructor.teaching_languages.all|slice:":3" %}
                <span class="badge bg-label-primary me-1">{{ language.name }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
        
        <!-- Session Reference (if applicable) -->
        {% if session %}
          <div class="alert alert-light-primary mb-4">
            <div class="d-flex">
              <i class="ti ti-info-circle me-2"></i>
              <div>
                <div class="fw-semibold">
                  Your review for:
                  {% if session_type == 'private' %}
                    Private session on {{ session.start_time|date:"M d, Y" }} at {{ session.start_time|time:"H:i" }}
                  {% else %}
                    {{ session.title }} (Group session) on {{ session.start_time|date:"M d, Y" }}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}
        
        <!-- Review Form -->
        <form method="post">
          {% csrf_token %}
          
          {% if form.errors %}
          <div class="alert alert-danger">
            <div class="alert-body">
              Please correct the errors below:
              <ul class="mb-0 mt-1">
                {% for field in form %}
                  {% if field.errors %}
                    {% for error in field.errors %}
                      <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}
          
          <!-- Rating Field -->
          <div class="mb-4">
            <label class="form-label">Rating</label>
            <div class="star-rating">
              <div class="d-flex justify-content-between mb-2">
                {% for i in "12345" %}
                  <div class="form-check">
                    <input class="form-check-input visually-hidden rating-input" type="radio" name="{{ form.rating.name }}" id="rating{{ i }}" value="{{ i }}" 
                      {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}>
                    <label class="form-check-label rating-label fs-2" for="rating{{ i }}">
                      <i class="ti ti-star"></i>
                    </label>
                  </div>
                {% endfor %}
              </div>
              <div class="rating-text text-center mb-3">
                <span id="ratingDescription" class="text-muted">Select a rating</span>
              </div>
            </div>
            {% if form.rating.errors %}
            <div class="invalid-feedback d-block">{{ form.rating.errors.0 }}</div>
            {% endif %}
          </div>
          
          <!-- Comment Field -->
          <div class="mb-4">
            <label for="{{ form.comment.id_for_label }}" class="form-label">Your Review</label>
            {{ form.comment }}
            {% if form.comment.errors %}
            <div class="invalid-feedback d-block">{{ form.comment.errors.0 }}</div>
            {% endif %}
            <small class="form-text text-muted">
              Share your experience with this instructor. What did you like? What could be improved?
            </small>
          </div>
          
          <!-- Submit Button -->
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </div>
        </form>
        
        <!-- Tips for Writing Reviews -->
        <div class="mt-4">
          <h6>Tips for Writing Helpful Reviews:</h6>
          <ul class="mb-0 text-muted small">
            <li>Be specific about your experience with the instructor</li>
            <li>Mention teaching style, communication skills, and lesson quality</li>
            <li>Provide constructive feedback that can help the instructor improve</li>
            <li>Consider how the instructor helped you achieve your learning goals</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Rating stars interaction
    const ratingLabels = document.querySelectorAll('.rating-label');
    const ratingInputs = document.querySelectorAll('.rating-input');
    const ratingDescription = document.getElementById('ratingDescription');
    
    const ratingTexts = {
      '1': 'Poor - Very dissatisfied',
      '2': 'Fair - Below expectations',
      '3': 'Good - Met expectations',
      '4': 'Very Good - Above expectations',
      '5': 'Excellent - Exceptional experience'
    };
    
    // Set initial description if a rating is selected
    ratingInputs.forEach(input => {
      if (input.checked) {
        updateRatingStars(input.value);
        ratingDescription.textContent = ratingTexts[input.value];
      }
    });
    
    // Star rating hover and click effects
    ratingLabels.forEach((label, index) => {
      // Hover effect
      label.addEventListener('mouseenter', () => {
        const rating = index + 1;
        updateRatingStars(rating);
        ratingDescription.textContent = ratingTexts[rating];
      });
      
      // Click effect
      label.addEventListener('click', () => {
        const rating = index + 1;
        document.getElementById('rating' + rating).checked = true;
        updateRatingStars(rating);
        ratingDescription.textContent = ratingTexts[rating];
      });
    });
    
    // Reset stars on mouse leave if no rating is selected
    document.querySelector('.star-rating').addEventListener('mouseleave', () => {
      let selectedRating = null;
      ratingInputs.forEach(input => {
        if (input.checked) {
          selectedRating = input.value;
        }
      });
      
      if (selectedRating) {
        updateRatingStars(selectedRating);
        ratingDescription.textContent = ratingTexts[selectedRating];
      } else {
        ratingLabels.forEach(label => {
          label.querySelector('i').className = 'ti ti-star';
        });
        ratingDescription.textContent = 'Select a rating';
      }
    });
    
    // Helper function to update star appearance
    function updateRatingStars(rating) {
      ratingLabels.forEach((label, i) => {
        const icon = label.querySelector('i');
        if (i < rating) {
          icon.className = 'ti ti-star-filled text-warning';
        } else {
          icon.className = 'ti ti-star';
        }
      });
    }
  });
</script>
{% endblock %}