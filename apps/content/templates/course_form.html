{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{% if course %}Edit Session: {{ course.title }}{% else %}Create New Session{% endif %} - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/dropzone/dropzone.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/quill/editor.js' %}"></script>
<script src="{% static 'vendor/libs/dropzone/dropzone.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">{{ title }}</h5>
    <a href="{% if course %}{% url 'content:course_detail' slug=course.slug %}{% else %}{% url 'content:teacher_courses' %}{% endif %}" class="btn btn-outline-secondary btn-sm">
      <i class="ti ti-arrow-left me-1"></i> Back
    </a>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="sessionForm">
      {% csrf_token %}
      
      <!-- Form errors -->
      {% if form.errors %}
      <div class="alert alert-danger mb-4">
        <div class="alert-body">
          Please correct the errors below:
          <ul class="mb-0 mt-1">
            {% for field in form %}
              {% if field.errors %}
                {% for error in field.errors %}
                  <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
              {% endif %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      
      <div class="row g-4">
        <!-- Session Title -->
        <div class="col-12">
          <label for="{{ form.title.id_for_label }}" class="form-label">Session Title</label>
          {{ form.title }}
          {% if form.title.help_text %}
          <small class="form-text text-muted">{{ form.title.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Session Language and Level -->
        <div class="col-md-6">
          <label for="{{ form.language.id_for_label }}" class="form-label">Language</label>
          <select name="language" id="{{ form.language.id_for_label }}" class="form-select" required>
            <option value="">Select language</option>
            {% for language in languages %}
              <option value="{{ language.id }}" {% if form.instance.language.id == language.id %}selected{% endif %}>{{ language.name }}</option>
            {% endfor %}
          </select>
          {% if form.language.help_text %}
          <small class="form-text text-muted">{{ form.language.help_text }}</small>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label for="{{ form.level.id_for_label }}" class="form-label">Level</label>
          <select name="level" id="{{ form.level.id_for_label }}" class="form-select" required>
            <option value="">Select level</option>
            {% for level in levels %}
              <option value="{{ level.id }}" {% if form.instance.level.id == level.id %}selected{% endif %}>{{ level.code }} - {{ level.name }}</option>
            {% endfor %}
          </select>
          {% if form.level.help_text %}
          <small class="form-text text-muted">{{ form.level.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Session Duration -->
        <div class="col-md-6">
          <label for="session_duration" class="form-label">Duration</label>
          <div class="row">
            <div class="col-6">
              <select name="duration_hours" id="duration_hours" class="form-select">
                <option value="0" {% if duration_hours == 0 %}selected{% endif %}>0 hours</option>
                <option value="1" {% if duration_hours == 1 %}selected{% endif %}>1 hour</option>
                <option value="2" {% if duration_hours == 2 %}selected{% endif %}>2 hours</option>
                <option value="3" {% if duration_hours == 3 %}selected{% endif %}>3 hours</option>
                <option value="4" {% if duration_hours == 4 %}selected{% endif %}>4 hours</option>
              </select>
            </div>
            <div class="col-6">
              <select name="duration_minutes" id="duration_minutes" class="form-select">
                <option value="0" {% if duration_minutes == 0 %}selected{% endif %}>0 minutes</option>
                <option value="15" {% if duration_minutes == 15 %}selected{% endif %}>15 minutes</option>
                <option value="30" {% if duration_minutes == 30 %}selected{% endif %}>30 minutes</option>
                <option value="45" {% if duration_minutes == 45 %}selected{% endif %}>45 minutes</option>
              </select>
            </div>
          </div>
          <small class="form-text text-muted">Total session duration</small>
          
          <input type="hidden" name="duration_weeks" id="duration_weeks" value="1">
        </div>
        
        <!-- Instructor Image -->
        <div class="col-md-6">
          <label for="{{ form.image.id_for_label }}" class="form-label">Instructor Image</label>
          <div class="input-group">
            {{ form.image }}
          </div>
          <small class="form-text text-muted">Upload your profile image or a session-relevant image</small>
          
          {% if course and course.image %}
          <div class="mt-2">
            <p class="mb-1">Current image:</p>
            <img src="{{ course.image.url }}" alt="{{ course.title }}" class="img-thumbnail" style="max-height: 150px;">
          </div>
          {% endif %}
        </div>
        
        <!-- Session Description -->
        <div class="col-12">
          <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
          {{ form.description }}
          {% if form.description.help_text %}
          <small class="form-text text-muted">{{ form.description.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Session Settings -->
        <div class="col-12">
          <h6 class="fw-semibold">Session Settings</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check form-switch mb-2">
                {{ form.is_published }}
                <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                  Published
                  <small class="d-block text-muted">Make this session visible to students</small>
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch mb-2">
                {{ form.is_featured }}
                <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                  Featured
                  <small class="d-block text-muted">Highlight this session on the platform</small>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="col-12 d-flex justify-content-end gap-2">
          <a href="{% if course %}{% url 'content:course_detail' slug=course.slug %}{% else %}{% url 'content:course_list' %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{{ submit_text|default:"Save" }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if course %}
<!-- Scheduled Sessions Section -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">Scheduled Sessions</h5>
    <a href="{% url 'booking:create_slot' %}?session_id={{ course.id }}" class="btn btn-primary btn-sm">
      <i class="ti ti-plus me-1"></i> Schedule New Session
    </a>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Duration</th>
            <th>Status</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          {% if session_slots %}
            {% for slot in session_slots %}
            <tr>
              <td>{{ slot.start_time|date:"M d, Y" }} at {{ slot.start_time|time:"H:i" }}</td>
              <td>{{ slot.duration }} minutes</td>
              <td>
                <span class="badge bg-label-{% if slot.status == 'available' %}primary{% elif slot.status == 'booked' %}success{% elif slot.status == 'completed' %}info{% else %}secondary{% endif %}">
                  {{ slot.status|title }}
                </span>
                {% if slot.status == 'booked' and slot.student %}
                  <small class="d-block">{{ slot.student.username }}</small>
                {% endif %}
              </td>
              <td>
                <div class="d-flex gap-2">
                  {% if slot.status == 'available' %}
                    <a href="{% url 'booking:edit_slot' slot_id=slot.id %}" class="btn btn-sm btn-icon btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
                      <i class="ti ti-edit"></i>
                    </a>
                    <form method="post" action="{% url 'booking:delete_slot' slot_id=slot.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-icon btn-outline-danger" data-bs-toggle="tooltip" title="Delete" onclick="return confirm('Are you sure you want to delete this slot?')">
                        <i class="ti ti-trash"></i>
                      </button>
                    </form>
                  {% elif slot.status == 'booked' %}
                    <a href="{% url 'booking:view_booking' slot_id=slot.id %}" class="btn btn-sm btn-icon btn-outline-primary" data-bs-toggle="tooltip" title="View">
                      <i class="ti ti-eye"></i>
                    </a>
                    {% if slot.meeting %}
                      <a href="{{ slot.meeting.meeting_link }}" class="btn btn-sm btn-icon btn-outline-success" data-bs-toggle="tooltip" title="Join Meeting">
                        <i class="ti ti-video"></i>
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center py-4">
                <p class="mb-2">No sessions have been scheduled yet.</p>
                <a href="{% url 'booking:create_slot' %}?session_id={{ course.id }}" class="btn btn-primary btn-sm">Schedule First Session</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize select2 for dropdowns
    $('.form-select').select2();
    
    // Initialize rich text editor for description
    var quill = new Quill('#{{ form.description.id_for_label }}', {
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          ['link'],
          ['clean']
        ]
      },
      theme: 'snow'
    });
    
    // Sync Quill editor with hidden textarea for form submission
    var form = document.getElementById('sessionForm');
    form.addEventListener('submit', function() {
      var descriptionInput = document.querySelector('textarea[name="description"]');
      descriptionInput.value = quill.root.innerHTML;
      
      // Calculate total minutes for duration_minutes field
      var hours = parseInt(document.getElementById('duration_hours').value) || 0;
      var minutes = parseInt(document.getElementById('duration_minutes').value) || 0;
      var totalMinutes = (hours * 60) + minutes;
      
      // Make sure we have at least 15 minutes
      if (totalMinutes < 15) {
        alert('Session duration must be at least 15 minutes');
        return false;
      }
      
      // Set the value to the hidden duration_minutes field
      document.getElementById('duration_weeks').value = Math.ceil(totalMinutes / (7 * 24 * 60));
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
{% endblock %}