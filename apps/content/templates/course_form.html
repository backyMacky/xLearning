{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{% if course %}Edit Course: {{ course.title }}{% else %}Create New Course{% endif %} - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/dropzone/dropzone.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/spinkit/spinkit.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/quill/editor.js' %}"></script>
<script src="{% static 'vendor/libs/dropzone/dropzone.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">{{ title }}</h5>
    <a href="{% if course %}{% url 'content:course_detail' slug=course.slug %}{% else %}{% url 'content:teacher_courses' %}{% endif %}" class="btn btn-outline-secondary btn-sm">
      <i class="ti ti-arrow-left me-1"></i> Back
    </a>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" id="courseForm">
      {% csrf_token %}
      
      <!-- Hidden AI fields -->
      {{ form.use_ai }}
      {{ form.ai_prompt }}
      {{ form.ai_tone }}
      
      <!-- Form errors -->
      {% if form.errors %}
      <div class="alert alert-danger mb-4">
        <div class="alert-body">
          Please correct the errors below:
          <ul class="mb-0 mt-1">
            {% for field in form %}
              {% if field.errors %}
                {% for error in field.errors %}
                  <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
              {% endif %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      
      <div class="row g-4">
        <!-- Course Title -->
        <div class="col-12">
          <label for="{{ form.title.id_for_label }}" class="form-label">Course Title</label>
          <div class="input-group">
            {{ form.title }}
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiTitleModal">
              <i class="ti ti-bulb me-1"></i> AI Assist
            </button>
          </div>
          {% if form.title.help_text %}
          <small class="form-text text-muted">{{ form.title.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Course Language and Level -->
        <div class="col-md-6">
          <label for="{{ form.language.id_for_label }}" class="form-label">Language</label>
          <select name="language" id="{{ form.language.id_for_label }}" class="form-select" required>
            <option value="">Select language</option>
            {% for language in languages %}
              <option value="{{ language.id }}" {% if form.instance.language.id == language.id %}selected{% endif %}>{{ language.name }}</option>
            {% endfor %}
          </select>
          {% if form.language.help_text %}
          <small class="form-text text-muted">{{ form.language.help_text }}</small>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label for="{{ form.level.id_for_label }}" class="form-label">Level</label>
          <select name="level" id="{{ form.level.id_for_label }}" class="form-select" required>
            <option value="">Select level</option>
            {% for level in levels %}
              <option value="{{ level.id }}" {% if form.instance.level.id == level.id %}selected{% endif %}>{{ level.code }} - {{ level.name }}</option>
            {% endfor %}
          </select>
          {% if form.level.help_text %}
          <small class="form-text text-muted">{{ form.level.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Course Duration -->
        <div class="col-md-6">
          <label for="course_duration" class="form-label">Duration</label>
          <div class="row">
            <div class="col-6">
              <select name="duration_hours" id="duration_hours" class="form-select">
                <option value="0" {% if duration_hours == 0 %}selected{% endif %}>0 hours</option>
                <option value="1" {% if duration_hours == 1 %}selected{% endif %}>1 hour</option>
                <option value="2" {% if duration_hours == 2 %}selected{% endif %}>2 hours</option>
                <option value="3" {% if duration_hours == 3 %}selected{% endif %}>3 hours</option>
                <option value="4" {% if duration_hours == 4 %}selected{% endif %}>4 hours</option>
              </select>
            </div>
            <div class="col-6">
              <select name="duration_minutes" id="duration_minutes" class="form-select">
                <option value="0" {% if duration_minutes == 0 %}selected{% endif %}>0 minutes</option>
                <option value="15" {% if duration_minutes == 15 %}selected{% endif %}>15 minutes</option>
                <option value="30" {% if duration_minutes == 30 %}selected{% endif %}>30 minutes</option>
                <option value="45" {% if duration_minutes == 45 %}selected{% endif %}>45 minutes</option>
              </select>
            </div>
          </div>
          <small class="form-text text-muted">Total session duration</small>
          
          <input type="hidden" name="duration_weeks" id="duration_weeks" value="1">
        </div>
        
        <!-- Instructor Image -->
        <div class="col-md-6">
          <label for="{{ form.image.id_for_label }}" class="form-label">Course Image</label>
          <div class="input-group">
            {{ form.image }}
          </div>
          <small class="form-text text-muted">Upload a course image (recommended size: 1200x600px)</small>
          
          {% if course and course.image %}
          <div class="mt-2">
            <p class="mb-1">Current image:</p>
            <img src="{{ course.image.url }}" alt="{{ course.title }}" class="img-thumbnail" style="max-height: 150px;">
          </div>
          {% endif %}
        </div>
        
        <!-- Course Description -->
        <div class="col-12">
          <label for="description-editor" class="form-label">Description</label>
          <div class="d-flex align-items-center mb-1">
            <div class="flex-grow-1">
              <div class="editor-toolbar"></div>
            </div>
            <div>
              <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#aiDescriptionModal">
                <i class="ti ti-bulb me-1"></i> AI Assist
              </button>
            </div>
          </div>
          <div id="description-editor" style="height: 200px;"></div>
          <textarea id="id_description" name="description" class="form-control d-none" rows="5" placeholder="Course Description" required>{% if form.description.value %}{{ form.description.value }}{% elif form.instance.description %}{{ form.instance.description }}{% endif %}</textarea>
          {% if form.description.help_text %}
          <small class="form-text text-muted">{{ form.description.help_text }}</small>
          {% endif %}
        </div>
        
        <!-- Course Settings -->
        <div class="col-12">
          <h6 class="fw-semibold">Course Settings</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check form-switch mb-2">
                {{ form.is_published }}
                <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                  Published
                  <small class="d-block text-muted">Make this course visible to students</small>
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch mb-2">
                {{ form.is_featured }}
                <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                  Featured
                  <small class="d-block text-muted">Highlight this course on the platform</small>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="col-12 d-flex justify-content-end gap-2">
          <a href="{% if course %}{% url 'content:course_detail' slug=course.slug %}{% else %}{% url 'content:course_list' %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{{ submit_text|default:"Save" }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if course %}
<!-- Scheduled Sessions Section -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">Scheduled Sessions</h5>
    <a href="{% url 'booking:create_slot' %}?session_id={{ course.id }}" class="btn btn-primary btn-sm">
      <i class="ti ti-plus me-1"></i> Schedule New Session
    </a>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Duration</th>
            <th>Status</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          {% if session_slots %}
            {% for slot in session_slots %}
            <tr>
              <td>{{ slot.start_time|date:"M d, Y" }} at {{ slot.start_time|time:"H:i" }}</td>
              <td>{{ slot.duration }} minutes</td>
              <td>
                <span class="badge bg-label-{% if slot.status == 'available' %}primary{% elif slot.status == 'booked' %}success{% elif slot.status == 'completed' %}info{% else %}secondary{% endif %}">
                  {{ slot.status|title }}
                </span>
                {% if slot.status == 'booked' and slot.student %}
                  <small class="d-block">{{ slot.student.username }}</small>
                {% endif %}
              </td>
              <td>
                <div class="d-flex gap-2">
                  {% if slot.status == 'available' %}
                    <a href="{% url 'booking:edit_slot' slot_id=slot.id %}" class="btn btn-sm btn-icon btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
                      <i class="ti ti-edit"></i>
                    </a>
                    <form method="post" action="{% url 'booking:delete_slot' slot_id=slot.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-icon btn-outline-danger" data-bs-toggle="tooltip" title="Delete" onclick="return confirm('Are you sure you want to delete this slot?')">
                        <i class="ti ti-trash"></i>
                      </button>
                    </form>
                  {% elif slot.status == 'booked' %}
                    <a href="{% url 'booking:view_booking' slot_id=slot.id %}" class="btn btn-sm btn-icon btn-outline-primary" data-bs-toggle="tooltip" title="View">
                      <i class="ti ti-eye"></i>
                    </a>
                    {% if slot.meeting %}
                      <a href="{{ slot.meeting.meeting_link }}" class="btn btn-sm btn-icon btn-outline-success" data-bs-toggle="tooltip" title="Join Meeting">
                        <i class="ti ti-video"></i>
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center py-4">
                <p class="mb-2">No sessions have been scheduled yet.</p>
                <a href="{% url 'booking:create_slot' %}?session_id={{ course.id }}" class="btn btn-primary btn-sm">Schedule First Session</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- AI Title Generator Modal -->
<div class="modal fade" id="aiTitleModal" tabindex="-1" aria-labelledby="aiTitleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiTitleModalLabel">Generate Course Title with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="titlePrompt" class="form-label">Describe your course</label>
          <textarea id="titlePrompt" class="form-control" rows="3" placeholder="Briefly describe what your course will cover, the language, level, and target audience"></textarea>
        </div>
        
        <div class="mb-3">
          <label for="titleTone" class="form-label">Tone</label>
          <select id="titleTone" class="form-select">
            <option value="professional">Professional</option>
            <option value="academic">Academic</option>
            <option value="friendly" selected>Friendly</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="concise">Concise</option>
          </select>
        </div>
        
        <div id="titleGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating title suggestions...</p>
        </div>
        
        <div id="titleResults" class="d-none">
          <label class="form-label">Choose a title:</label>
          <div class="title-suggestions"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="generateTitleBtn">Generate Titles</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Description Generator Modal -->
<div class="modal fade" id="aiDescriptionModal" tabindex="-1" aria-labelledby="aiDescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiDescriptionModalLabel">Generate Course Description with AI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="descriptionPrompt" class="form-label">What would you like to generate?</label>
          <textarea id="descriptionPrompt" class="form-control" rows="4" placeholder="Describe the content of your course, target audience, learning outcomes, teaching style, etc."></textarea>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="descriptionTone" class="form-label">Tone</label>
            <select id="descriptionTone" class="form-select">
              <option value="professional">Professional</option>
              <option value="academic">Academic</option>
              <option value="friendly" selected>Friendly</option>
              <option value="enthusiastic">Enthusiastic</option>
              <option value="concise">Concise</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="descriptionLength" class="form-label">Length</label>
            <select id="descriptionLength" class="form-select">
              <option value="150">Short</option>
              <option value="300" selected>Medium</option>
              <option value="500">Long</option>
            </select>
          </div>
        </div>
        
        <div id="descriptionGenerating" class="d-none text-center py-3">
          <div class="sk-wave sk-primary">
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
            <div class="sk-wave-rect"></div>
          </div>
          <p class="mt-2">Generating description... This may take a moment.</p>
        </div>
        
        <div id="descriptionResults" class="d-none">
          <label class="form-label">Generated Description:</label>
          <div class="card">
            <div class="card-body">
              <div id="descriptionPreview" class="border p-3 rounded bg-light" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success d-none" id="useDescriptionBtn">Use This Description</button>
        <button type="button" class="btn btn-primary" id="generateDescriptionBtn">Generate Description</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js_extra %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token for API requests
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Initialize select2 for dropdowns
    $('.form-select').select2();
    
    // Initialize rich text editor for description
    var quill = new Quill('#description-editor', {
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          ['link'],
          ['clean']
        ]
      },
      theme: 'snow'
    });
    
    // Set initial content if available
    const descriptionField = document.querySelector('#id_description');
    if (descriptionField.value) {
      quill.root.innerHTML = descriptionField.value;
    }
    
    // Sync Quill editor with hidden textarea for form submission
    var form = document.getElementById('courseForm');
    form.addEventListener('submit', function() {
      var descriptionInput = document.querySelector('textarea[name="description"]');
      descriptionInput.value = quill.root.innerHTML;
      
      // Calculate total minutes for duration_minutes field
      var hours = parseInt(document.getElementById('duration_hours').value) || 0;
      var minutes = parseInt(document.getElementById('duration_minutes').value) || 0;
      var totalMinutes = (hours * 60) + minutes;
      
      // Make sure we have at least 15 minutes
      if (totalMinutes < 15) {
        alert('Session duration must be at least 15 minutes');
        return false;
      }
      
      // Set the value to the hidden duration_minutes field
      document.getElementById('duration_weeks').value = Math.ceil(totalMinutes / (7 * 24 * 60));
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Generate AI Title
    const generateTitleBtn = document.getElementById('generateTitleBtn');
    generateTitleBtn.addEventListener('click', function() {
      const prompt = document.getElementById('titlePrompt').value;
      const tone = document.getElementById('titleTone').value;
      
      if (!prompt) {
        alert('Please enter a description of your course.');
        return;
      }
      
      // Show loading indicator
      document.getElementById('titleGenerating').classList.remove('d-none');
      document.getElementById('titleResults').classList.add('d-none');
      generateTitleBtn.disabled = true;
      
      // Prepare the actual prompt
      const titlePrompt = `Generate 3 engaging, catchy titles for a language learning course about: ${prompt}. Each title should be concise, appealing to students, and clearly communicate the course focus.`;
      
      // Call the API
      fetch('{% url "content:api_generate_suggestions" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          text: titlePrompt,
          suggestion_count: 3,
          max_tokens: 100
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('titleGenerating').classList.add('d-none');
        document.getElementById('titleResults').classList.remove('d-none');
        generateTitleBtn.disabled = false;
        
        if (data.error) {
          document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        const suggestionsContainer = document.querySelector('.title-suggestions');
        suggestionsContainer.innerHTML = '';
        
        // Create buttons for each suggestion
        data.suggestions.forEach((title, index) => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-outline-primary w-100 mb-2 text-start';
          btn.innerHTML = title;
          btn.addEventListener('click', function() {
            // Set the title in the form
            document.getElementById('{{ form.title.id_for_label }}').value = title;
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('aiTitleModal')).hide();
          });
          suggestionsContainer.appendChild(btn);
        });
      })
      .catch(error => {
        document.getElementById('titleGenerating').classList.add('d-none');
        document.querySelector('.title-suggestions').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateTitleBtn.disabled = false;
      });
    });
    
    // Generate AI Description
    const generateDescriptionBtn = document.getElementById('generateDescriptionBtn');
    const useDescriptionBtn = document.getElementById('useDescriptionBtn');
    let generatedDescription = '';
    
    generateDescriptionBtn.addEventListener('click', function() {
      const prompt = document.getElementById('descriptionPrompt').value;
      const tone = document.getElementById('descriptionTone').value;
      const maxTokens = document.getElementById('descriptionLength').value;
      
      if (!prompt) {
        alert('Please describe what content you would like to generate.');
        return;
      }
      
      // Show loading indicator
      document.getElementById('descriptionGenerating').classList.remove('d-none');
      document.getElementById('descriptionResults').classList.add('d-none');
      useDescriptionBtn.classList.add('d-none');
      generateDescriptionBtn.disabled = true;
      
      // Prepare the actual prompt
      const descriptionPrompt = `Write a compelling description for a language learning course with the following details: ${prompt}. The description should be engaging, clearly explain what students will learn, and motivate them to enroll. Include the learning outcomes, course structure, and benefits of taking this course.`;
      
      // Call the API
      fetch('{% url "content:api_generate_text" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          prompt: descriptionPrompt,
          tone: tone,
          max_tokens: parseInt(maxTokens)
        })
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading, show results
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionResults').classList.remove('d-none');
        generateDescriptionBtn.disabled = false;
        useDescriptionBtn.classList.remove('d-none');
        
        if (data.error) {
          document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        
        // Store the generated content
        generatedDescription = data.text;
        
        // Display the generated content
        document.getElementById('descriptionPreview').innerHTML = generatedDescription.replace(/\n/g, '<br>');
      })
      .catch(error => {
        document.getElementById('descriptionGenerating').classList.add('d-none');
        document.getElementById('descriptionPreview').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        generateDescriptionBtn.disabled = false;
      });
    });
    
    // Use the generated description
    useDescriptionBtn.addEventListener('click', function() {
      // Set the content in Quill
      quill.root.innerHTML = generatedDescription.replace(/\n/g, '<br>');
      
      // Update the hidden field
      document.querySelector('#id_description').value = quill.root.innerHTML;
      
      // Close the modal
      bootstrap.Modal.getInstance(document.getElementById('aiDescriptionModal')).hide();
    });
  });
</script>
{% endblock %}