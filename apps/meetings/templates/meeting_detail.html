{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Meeting Details - Learning Platform{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <!-- Main meeting info -->
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex align-items-center">
          <div class="avatar me-3">
            <div class="avatar-initial rounded bg-label-primary">
              <i class="ti ti-video"></i>
            </div>
          </div>
          <div>
            <h5 class="mb-0">{{ meeting.title }}</h5>
            <small class="text-muted">Meeting ID: #{{ meeting.id }}</small>
          </div>
        </div>
        
        <div>
          <a href="{% url 'meetings:meeting_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="ti ti-arrow-left me-1"></i> Back to Meetings
          </a>
        </div>
      </div>
      
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-lg-6">
            <!-- Status badge (larger and more prominent) -->
            {% if is_active %}
              <div class="d-inline-block mb-3">
                <div class="badge bg-success p-2 d-flex align-items-center gap-1">
                  <i class="ti ti-player-play"></i>
                  <span class="fs-6">Active Now</span>
                </div>
              </div>
            {% endif %}
            
            <!-- Meeting Details Table -->
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <tbody>
                  <tr>
                    <th class="ps-0 w-25">
                      <i class="ti ti-calendar text-primary me-1"></i> Date:
                    </th>
                    <td class="fw-medium">{{ meeting.start_time|date:"l, F j, Y" }}</td>
                  </tr>
                  <tr>
                    <th class="ps-0">
                      <i class="ti ti-clock text-primary me-1"></i> Time:
                    </th>
                    <td class="fw-medium">{{ meeting.start_time|date:"h:i A" }}</td>
                  </tr>
                  <tr>
                    <th class="ps-0">
                      <i class="ti ti-hourglass text-primary me-1"></i> Duration:
                    </th>
                    <td class="fw-medium">{{ meeting.duration }} minutes</td>
                  </tr>
                  <tr>
                    <th class="ps-0">
                      <i class="ti ti-activity text-primary me-1"></i> Status:
                    </th>
                    <td>
                      {% if meeting.start_time > now %}
                        <span class="badge bg-label-primary">Upcoming</span>
                      {% elif is_active %}
                        <span class="badge bg-label-success">Active</span>
                      {% else %}
                        <span class="badge bg-label-secondary">Completed</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th class="ps-0">
                      {% if is_teacher %}
                        <i class="ti ti-users text-primary me-1"></i> Students:
                      {% else %}
                        <i class="ti ti-user text-primary me-1"></i> Teacher:
                      {% endif %}
                    </th>
                    <td>
                      {% if is_teacher %}
                        <div class="d-flex flex-wrap gap-1">
                          {% for student in meeting.students.all %}
                            <span class="badge bg-label-info">{{ student.username }}</span>
                          {% empty %}
                            <span class="text-muted">No students enrolled</span>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="d-flex align-items-center">
                          <span class="avatar avatar-sm me-2 bg-label-primary">
                            {{ meeting.teacher.username|slice:":1" }}
                          </span>
                          <span>{{ meeting.teacher.username }}</span>
                        </div>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="col-lg-6">
            {% if meeting.start_time > now %}
              <!-- Countdown Timer for upcoming meetings -->
              <div class="card bg-primary text-white shadow-sm mb-3">
                <div class="card-body text-center">
                  <h6 class="card-title text-white mb-3">Time Until Meeting</h6>
                  <div id="meeting-countdown" 
                     data-meeting-time="{{ meeting.start_time|date:'c' }}"
                     class="d-flex justify-content-center gap-3">
                    <div class="text-center">
                      <h3 id="days" class="mb-1">0</h3>
                      <small>Days</small>
                    </div>
                    <div class="text-center">
                      <h3 id="hours" class="mb-1">0</h3>
                      <small>Hours</small>
                    </div>
                    <div class="text-center">
                      <h3 id="minutes" class="mb-1">0</h3>
                      <small>Minutes</small>
                    </div>
                    <div class="text-center">
                      <h3 id="seconds" class="mb-1">0</h3>
                      <small>Seconds</small>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
            
            <!-- Meeting Link Card (with special styling if active) -->
            {% if meeting.meeting_link %}
              <div class="card {% if is_active %}bg-success text-white animate__animated animate__pulse animate__infinite{% else %}bg-light{% endif %} shadow-sm">
                <div class="card-body">
                  <h6 class="card-title {% if is_active %}text-white{% endif %} mb-2">
                    <i class="ti ti-video me-1"></i> Meeting Link
                  </h6>
                  <p class="card-text mb-3 small">
                    {% if is_active %}
                      Your meeting is now active! Click the button below to join.
                    {% else %}
                      Use this link to join the meeting at the scheduled time.
                    {% endif %}
                  </p>
                  <a href="{{ meeting.meeting_link }}" target="_blank" class="btn btn-sm {% if is_active %}btn-light{% else %}btn-primary{% endif %} w-100">
                    <i class="ti ti-external-link me-1"></i> 
                    {% if is_active %}Join Meeting Now{% else %}Open Meeting Link{% endif %}
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 mt-3">
          {% if meeting.start_time|date:"U"|add:"0" < now|date:"U"|add:"300" and meeting.start_time|date:"U"|add:"0" > now|date:"U"|add:"-3600" %}
            <a href="{{ meeting.meeting_link }}" target="_blank" class="btn btn-primary">
              <i class="ti ti-video me-1"></i> Join Meeting
            </a>
          {% endif %}
          
          {% if is_teacher and meeting.teacher == request.user %}
            {% if meeting.start_time > now %}
              <a href="{% url 'meetings:edit_meeting' meeting_id=meeting.id %}" class="btn btn-info">
                <i class="ti ti-edit me-1"></i> Edit Meeting
              </a>
              
              <a href="{% url 'meetings:send_reminder' meeting_id=meeting.id %}" class="btn btn-warning send-reminder-btn">
                <i class="ti ti-bell me-1"></i> Send Reminder
              </a>
              
              <a href="{% url 'meetings:cancel_meeting' meeting_id=meeting.id %}" class="btn btn-danger">
                <i class="ti ti-trash me-1"></i> Cancel Meeting
              </a>
            {% endif %}
          {% endif %}
          
          <!-- Add to Calendar Button -->
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="calendarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="ti ti-calendar-plus me-1"></i> Add to Calendar
            </button>
            <ul class="dropdown-menu" aria-labelledby="calendarDropdown">
              <li>
                <a class="dropdown-item" href="{{ google_calendar_link }}" target="_blank">
                  <i class="ti ti-brand-google me-1"></i> Google Calendar
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="download-ical">
                  <i class="ti ti-calendar me-1"></i> iCal File (.ics)
                </a>
              </li>
            </ul>
          </div>
          
          <!-- Share Button -->
          <button type="button" class="btn btn-outline-secondary" id="share-meeting-btn">
            <i class="ti ti-share me-1"></i> Share
          </button>
        </div>
      </div>
    </div>
    
    <!-- Meeting Notes Card (optional) -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Meeting Notes</h5>
        <button type="button" class="btn btn-outline-primary btn-sm" id="edit-notes-btn">
          <i class="ti ti-edit me-1"></i> Edit
        </button>
      </div>
      <div class="card-body">
        <div id="meeting-notes-display">
          <p class="text-muted fst-italic mb-0">No notes have been added for this meeting yet.</p>
        </div>
        <div id="meeting-notes-editor" class="d-none">
          <textarea class="form-control mb-3" rows="4" id="notes-content"></textarea>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-notes-btn">
              Cancel
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="save-notes-btn">
              Save Notes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Side column -->
  <div class="col-md-4">
    <!-- Meeting Resources Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Meeting Resources</h5>
      </div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <div class="avatar avatar-sm bg-label-success">
              <i class="ti ti-file-text"></i>
            </div>
            <div>
              <h6 class="mb-0">Meeting Agenda</h6>
              <small class="text-muted">PDF document</small>
            </div>
            <i class="ti ti-download ms-auto"></i>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <div class="avatar avatar-sm bg-label-primary">
              <i class="ti ti-presentation"></i>
            </div>
            <div>
              <h6 class="mb-0">Presentation Slides</h6>
              <small class="text-muted">PowerPoint</small>
            </div>
            <i class="ti ti-download ms-auto"></i>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Quick Info Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Important Information</h5>
      </div>
      <div class="card-body">
        <ul class="ps-3 mb-0">
          <li class="mb-2">Please join the meeting 5 minutes before the scheduled time.</li>
          <li class="mb-2">Make sure your camera and microphone are working properly.</li>
          <li class="mb-2">Have all necessary materials ready before the meeting starts.</li>
          <li class="mb-0">If you encounter any technical issues, please contact support.</li>
        </ul>
      </div>
    </div>
    
    <!-- Technical Requirements Card -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Technical Requirements</h5>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="avatar avatar-sm bg-label-info me-3">
            <i class="ti ti-device-laptop"></i>
          </div>
          <div>
            <h6 class="mb-0">Computer with camera</h6>
            <small class="text-muted">For best experience</small>
          </div>
        </div>
        <div class="d-flex align-items-center mb-3">
          <div class="avatar avatar-sm bg-label-info me-3">
            <i class="ti ti-microphone"></i>
          </div>
          <div>
            <h6 class="mb-0">Working microphone</h6>
            <small class="text-muted">Required for participation</small>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <div class="avatar avatar-sm bg-label-info me-3">
            <i class="ti ti-world"></i>
          </div>
          <div>
            <h6 class="mb-0">Stable internet connection</h6>
            <small class="text-muted">Minimum 2Mbps upload/download</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Countdown timer for upcoming meetings
    const countdownElement = document.getElementById('meeting-countdown');
    
    if (countdownElement) {
      const meetingTime = new Date(countdownElement.dataset.meetingTime);
      
      function updateCountdown() {
        const now = new Date().getTime();
        const distance = meetingTime - now;
        
        if (distance < 0) {
          // Meeting time has passed
          document.getElementById('days').textContent = '0';
          document.getElementById('hours').textContent = '0';
          document.getElementById('minutes').textContent = '0';
          document.getElementById('seconds').textContent = '0';
          
          // Refresh the page if the meeting is now active
          if (distance > -1000 && distance < 0) {
            location.reload();
          }
          return;
        }
        
        // Calculate time units
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Update the countdown
        document.getElementById('days').textContent = days;
        document.getElementById('hours').textContent = hours;
        document.getElementById('minutes').textContent = minutes;
        document.getElementById('seconds').textContent = seconds;
      }
      
      // Initial update
      updateCountdown();
      
      // Update every second
      setInterval(updateCountdown, 1000);
    }
    
    // Send reminder button with confirmation
    const reminderBtn = document.querySelector('.send-reminder-btn');
    if (reminderBtn) {
      reminderBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        Swal.fire({
          title: 'Send Reminder',
          text: 'Are you sure you want to send a reminder to all participants?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, send reminder',
          customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-outline-danger ms-1'
          },
          buttonsStyling: false
        }).then(function(result) {
          if (result.isConfirmed) {
            window.location.href = reminderBtn.getAttribute('href');
          }
        });
      });
    }
    
    // Share meeting button
    const shareBtn = document.getElementById('share-meeting-btn');
    if (shareBtn) {
      shareBtn.addEventListener('click', function() {
        if (navigator.share) {
          navigator.share({
            title: '{{ meeting.title }}',
            text: 'Join our meeting on {{ meeting.start_time|date:"l, F j" }} at {{ meeting.start_time|date:"h:i A" }}',
            url: window.location.href
          })
          .catch(console.error);
        } else {
          // Fallback for browsers that don't support Web Share API
          const temp = document.createElement('textarea');
          temp.value = window.location.href;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
          
          Swal.fire({
            title: 'Link Copied!',
            text: 'Meeting link has been copied to clipboard.',
            icon: 'success',
            showConfirmButton: false,
            timer: 1500,
            customClass: {
              popup: 'animate__animated animate__fadeInUp'
            }
          });
        }
      });
    }
    
    // Notes functionality
    const editNotesBtn = document.getElementById('edit-notes-btn');
    const cancelNotesBtn = document.getElementById('cancel-notes-btn');
    const saveNotesBtn = document.getElementById('save-notes-btn');
    const notesDisplay = document.getElementById('meeting-notes-display');
    const notesEditor = document.getElementById('meeting-notes-editor');
    const notesContent = document.getElementById('notes-content');
    
    if (editNotesBtn) {
      editNotesBtn.addEventListener('click', function() {
        notesDisplay.classList.add('d-none');
        notesEditor.classList.remove('d-none');
        // In a real app, you'd load existing notes from server here
      });
      
      cancelNotesBtn.addEventListener('click', function() {
        notesDisplay.classList.remove('d-none');
        notesEditor.classList.add('d-none');
      });
      
      saveNotesBtn.addEventListener('click', function() {
        // In a real app, you'd save the notes to the server here
        const notes = notesContent.value;
        if (notes.trim()) {
          notesDisplay.innerHTML = notes.replace(/\n/g, '<br>');
        } else {
          notesDisplay.innerHTML = '<p class="text-muted fst-italic mb-0">No notes have been added for this meeting yet.</p>';
        }
        notesDisplay.classList.remove('d-none');
        notesEditor.classList.add('d-none');
        
        Swal.fire({
          title: 'Notes Saved!',
          text: 'Your meeting notes have been saved successfully.',
          icon: 'success',
          showConfirmButton: false,
          timer: 1500
        });
      });
    }
    
    // Download iCal file functionality
    const downloadICalBtn = document.getElementById('download-ical');
    if (downloadICalBtn) {
      downloadICalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // In a real app, you'd generate this server-side or call an API
        const now = new Date();
        const uid = `meeting-{{ meeting.id }}-${now.getTime()}@learningplatform.com`;
        const startTime = new Date('{{ meeting.start_time|date:"Y-m-d H:i:s" }}');
        const endTime = new Date(startTime.getTime() + {{ meeting.duration }} * 60000);
        
        // Format dates for iCal
        const formatDate = (date) => {
          return date.toISOString().replace(/-|:|\.\d+/g, '');
        };
        
        const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Learning Platform//Meeting Calendar//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
SUMMARY:{{ meeting.title }}
DTSTART:${formatDate(startTime)}
DTEND:${formatDate(endTime)}
DESCRIPTION:Meeting with {{ meeting.teacher.username }}{% if meeting.meeting_link %}\nJoin URL: {{ meeting.meeting_link }}{% endif %}
LOCATION:{% if meeting.meeting_link %}{{ meeting.meeting_link }}{% else %}Online Meeting{% endif %}
STATUS:CONFIRMED
SEQUENCE:0
UID:${uid}
DTSTAMP:${formatDate(now)}
END:VEVENT
END:VCALENDAR`;
        
        // Create a downloadable link
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'meeting-{{ meeting.id }}.ics';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }
  });
</script>
{% endblock %}